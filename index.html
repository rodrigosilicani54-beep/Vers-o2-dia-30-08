<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Agendamento - Cl√≠nica ABA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .appointment-slot {
            min-height: 35px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 11px;
        }
        .appointment-slot:hover {
            background-color: #f3f4f6;
            transform: scale(1.02);
        }
        .appointment-card {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .appointment-card:hover {
            transform: scale(1.02);
        }
        .blocked-slot {
            background: repeating-linear-gradient(
                45deg,
                #e5e7eb,
                #e5e7eb 8px,
                #d1d5db 8px,
                #d1d5db 16px
            );
            border: 1px solid #9ca3af;
        }
        .professional-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .professional-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .schedule-grid {
            display: grid;
            grid-template-columns: 60px repeat(6, 1fr);
            gap: 1px;
            background: #e5e7eb;
            max-height: 65vh;
            overflow-y: auto;
        }
        .time-slot {
            background: white;
            padding: 4px 2px;
            text-align: center;
            border: 1px solid #e5e7eb;
            min-height: 35px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 10px;
            line-height: 1.2;
        }
        .day-header {
            background: #f3f4f6;
            font-weight: bold;
            padding: 8px 4px;
            text-align: center;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .time-label {
            background: #f9fafb;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            position: sticky;
            left: 0;
            z-index: 5;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto p-1 max-w-full">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-3 mb-3">
            <h1 class="text-2xl font-bold text-gray-800 mb-1">Sistema de Agendamento - Cl√≠nica ABA</h1>
            <p class="text-gray-600 mb-3 text-sm">Gest√£o completa de agendamentos por especialidade</p>
            
            <!-- Legenda de Cores -->
            <div class="flex flex-wrap gap-2 mb-3 text-xs">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-orange-500 rounded"></div>
                    <span>Atendimento Cl√≠nica</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-pink-500 rounded"></div>
                    <span>An√°lise</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-blue-500 rounded"></div>
                    <span>Discuss√£o de Caso</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-green-500 rounded"></div>
                    <span>CLS</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-yellow-200 rounded border border-gray-300"></div>
                    <span>Supervis√£o</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-purple-500 rounded"></div>
                    <span>Treinamento</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-yellow-400 rounded"></div>
                    <span>Orienta√ß√£o Parental</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-gray-300 rounded border-2 border-gray-500"></div>
                    <span>Hor√°rio Bloqueado</span>
                </div>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="flex flex-wrap gap-2">
                <button onclick="showProfessionalsView(); trackResetSequence('professionals')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                    üìã Profissionais
                </button>
                <button onclick="openProfessionalModal(); trackResetSequence('cadastrar')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                    üë®‚Äç‚öïÔ∏è Cadastrar
                </button>
                <button onclick="openScheduleModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                    üìÖ Agendar
                </button>
                <button onclick="openExportModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                    üìä Excel
                </button>
                <button onclick="showReports()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                    üìà Relat√≥rios
                </button>
                <button onclick="showWeeklyView()" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                    üìÖ Semanal
                </button>
                <button onclick="openBulkEditModal()" class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                    ‚úèÔ∏è Edi√ß√£o em Lote
                </button>
                <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                    üóëÔ∏è Limpar Tudo
                </button>
                
                <!-- Hidden System Reset Button -->
                <button id="hiddenResetButton" onclick="executeSystemReset()" class="bg-red-800 hover:bg-red-900 text-white px-3 py-1 rounded text-sm font-medium transition-colors" style="display: none;">
                    üî• RESETAR SISTEMA
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="mainContent">
            <!-- Schedule View (Default) -->
            <div id="scheduleView" class="bg-white rounded-lg shadow-lg p-3">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-bold text-gray-800">Agenda Semanal</h2>
                </div>
                
                <!-- Professional Filter -->
                <div class="mb-3 bg-gray-50 p-3 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium mb-1">üîç Pesquisar Profissional:</label>
                            <input 
                                type="text" 
                                id="mainProfessionalSearch" 
                                placeholder="Digite o nome do profissional..." 
                                onkeyup="searchMainProfessionals()"
                                class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500"
                            >
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">üë®‚Äç‚öïÔ∏è Filtrar por Profissional:</label>
                            <select id="professionalFilter" onchange="filterByProfessional()" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500">
                                <option value="">Todos os Profissionais</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Clear Filter Button -->
                    <div class="mt-2 text-center">
                        <button onclick="clearMainProfessionalSelection()" class="text-blue-600 hover:text-blue-800 font-medium text-xs">
                            ‚úï Limpar Filtros
                        </button>
                    </div>
                </div>
                

                
                <!-- Schedule Grid -->
                <div id="scheduleGrid" class="schedule-grid overflow-x-auto"></div>
            </div>

            <!-- Professionals View -->
            <div id="professionalsView" class="bg-white rounded-lg shadow-lg p-4" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Profissionais Cadastrados</h2>
                <div id="professionalsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- Reports View -->
            <div id="reportsView" class="bg-white rounded-lg shadow-lg p-4" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Relat√≥rios</h2>
                <div id="reportsContent" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>

            <!-- Weekly View -->
            <div id="weeklyView" class="bg-white rounded-lg shadow-lg p-4" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Agenda Semanal por Profissional</h2>
                
                <!-- Professional Search and Filter -->
                <div class="mb-4 bg-gray-50 p-3 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Professional Search -->
                        <div>
                            <label class="block text-sm font-medium mb-2">üîç Pesquisar Profissional:</label>
                            <input 
                                type="text" 
                                id="professionalSearch" 
                                placeholder="Digite o nome do profissional..." 
                                onkeyup="searchProfessionals()"
                                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            >
                        </div>
                        
                        <!-- Professional Selection -->
                        <div>
                            <label class="block text-sm font-medium mb-2">üë®‚Äç‚öïÔ∏è Selecionar Profissional:</label>
                            <select id="weeklyProfessionalFilter" onchange="filterWeeklyByProfessional()" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Todos os Profissionais</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Selected Professional Info -->
                    <div id="selectedProfessionalInfo" class="mt-4 hidden">
                        <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="font-medium text-blue-800">Visualizando agenda de:</span>
                                    <span id="selectedProfessionalName" class="font-bold text-blue-900 ml-2"></span>
                                    <span id="selectedProfessionalSpecialty" class="text-blue-600 ml-2"></span>
                                </div>
                                <button onclick="clearProfessionalSelection()" class="text-blue-600 hover:text-blue-800 font-medium">
                                    ‚úï Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Weekly Schedule Grid -->
                <div id="weeklyScheduleGrid" class="schedule-grid overflow-x-auto"></div>
                
                <!-- Empty State -->
                <div id="weeklyEmptyState" class="text-center py-12 hidden">
                    <div class="text-6xl mb-4">üìÖ</div>
                    <h3 class="text-xl font-medium text-gray-600 mb-2">Nenhum agendamento encontrado</h3>
                    <p class="text-gray-500">Selecione um profissional para ver sua agenda semanal</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Modal -->
    <div id="professionalModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">Cadastrar Profissional</h3>
            <form onsubmit="saveProfessional(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Nome:</label>
                    <input type="text" id="profName" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Especialidade:</label>
                    <select id="profSpecialty" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="ATAC">ATAC</option>
                        <option value="ATM">ATM</option>
                        <option value="ATs">ATs</option>
                        <option value="FONO">FONO</option>
                        <option value="MUSICOTERAPIA">MUSICOTERAPIA</option>
                        <option value="NEUROPSI">NEUROPSI</option>
                        <option value="PSICO ABA">PSICO ABA</option>
                        <option value="PSICO COMUM">PSICO COMUM</option>
                        <option value="PSICOMOTRICIDADE">PSICOMOTRICIDADE</option>
                        <option value="T.O">T.O</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Cor de Identifica√ß√£o:</label>
                    <select id="profColor" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="bg-blue-500">Azul</option>
                        <option value="bg-green-500">Verde</option>
                        <option value="bg-purple-500">Roxo</option>
                        <option value="bg-red-500">Vermelho</option>
                        <option value="bg-yellow-500">Amarelo</option>
                        <option value="bg-pink-500">Rosa</option>
                        <option value="bg-indigo-500">√çndigo</option>
                        <option value="bg-teal-500">Teal</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium flex-1">
                        Salvar
                    </button>
                    <button type="button" onclick="closeModal('professionalModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-center text-blue-800">üìä Exportar/Importar Planilha</h3>
            
            <!-- Export Section -->
            <div class="mb-8">
                <h4 class="text-lg font-bold mb-4 text-green-700">üì§ Exportar Dados</h4>
                <div class="bg-green-50 p-4 rounded-lg mb-4">
                    <p class="text-sm text-green-800 mb-3">
                        <strong>Regras de Exporta√ß√£o:</strong>
                    </p>
                    <ul class="text-sm text-green-700 space-y-1 ml-4">
                        <li>‚Ä¢ Todos os agendamentos ser√£o exportados em formato Excel (.xlsx)</li>
                        <li>‚Ä¢ Os dados incluem: Data, Hor√°rio, Profissional, Cliente, Tipo e Observa√ß√µes</li>
                        <li>‚Ä¢ A planilha ser√° ordenada por data e hor√°rio automaticamente</li>
                        <li>‚Ä¢ Formato de data: DD/MM/AAAA (padr√£o brasileiro)</li>
                        <li>‚Ä¢ Colunas com largura otimizada para visualiza√ß√£o</li>
                    </ul>
                </div>
                <button onclick="exportScheduleFromModal()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-medium">
                    üìä Baixar Planilha Excel
                </button>
            </div>

            <!-- Import Section -->
            <div class="mb-6">
                <h4 class="text-lg font-bold mb-4 text-blue-700">üì• Importar Dados</h4>
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <p class="text-sm text-blue-800 mb-3">
                        <strong>Regras de Importa√ß√£o:</strong>
                    </p>
                    <ul class="text-sm text-blue-700 space-y-1 ml-4">
                        <li>‚Ä¢ Aceita apenas arquivos Excel (.xlsx)</li>
                        <li>‚Ä¢ Nome do profissional deve estar na c√©lula <strong>B1</strong></li>
                        <li>‚Ä¢ Hor√°rios na coluna B (B3 a B16) - 7:00 √†s 19:00</li>
                        <li>‚Ä¢ <strong>Segunda-feira:</strong> C3 a C16</li>
                        <li>‚Ä¢ <strong>Ter√ßa-feira:</strong> D3 a D16</li>
                        <li>‚Ä¢ <strong>Quarta-feira:</strong> E3 a E16</li>
                        <li>‚Ä¢ <strong>Quinta-feira:</strong> F3 a F16</li>
                        <li>‚Ä¢ <strong>Sexta-feira:</strong> G3 a G16</li>
                        <li>‚Ä¢ <strong>S√°bado:</strong> H3 a H16</li>
                        <li>‚Ä¢ <strong>Domingo:</strong> Ignorado (n√£o h√° trabalho)</li>
                        <li>‚Ä¢ <strong>Detec√ß√£o por Cores e Conte√∫do:</strong></li>
                        <li class="ml-4">üü† Laranja = Atendimento Cl√≠nica</li>
                        <li class="ml-4">ü©∑ Rosa = An√°lise</li>
                        <li class="ml-4">üîµ Azul = Discuss√£o de Caso</li>
                        <li class="ml-4">üü¢ Verde = CLS</li>
                        <li class="ml-4">üü° Amarelo Claro = Supervis√£o (ou texto com "Sup", "Clarissa", "Reinaldo", "Hellen", "Talita", "Thais", "Rosi", "Leticia", "Dimaima", "Natalia Lira", "Poliana")</li>
                        <li class="ml-4">üü£ Roxo = Treinamento (ou texto com "Trein", "Reun")</li>
                        <li class="ml-4">üü® Amarelo Gema = Orienta√ß√£o Parental</li>
                        <li class="ml-4">‚¨ú Cinza = Almo√ßo/Deslocamento/Bloqueado</li>
                        <li>‚Ä¢ <strong>ATEN√á√ÉO:</strong> A importa√ß√£o substituir√° todos os agendamentos existentes</li>
                    </ul>
                </div>
                
                <div class="border-2 border-dashed border-blue-300 rounded-lg p-6 text-center">
                    <input type="file" id="importFile" accept=".xlsx,.csv" class="hidden" onchange="handleFileSelect(event)">
                    <div id="dropArea" class="cursor-pointer" onclick="document.getElementById('importFile').click()">
                        <div class="text-4xl mb-2">üìÅ</div>
                        <p class="text-blue-600 font-medium mb-2">Clique aqui ou arraste o arquivo</p>
                        <p class="text-sm text-gray-500">Formatos aceitos: .xlsx, .csv</p>
                    </div>
                    <div id="fileInfo" class="mt-4 hidden">
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <p class="text-sm font-medium text-blue-800" id="fileName"></p>
                            <button onclick="importSchedule()" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                üì• Importar Dados
                            </button>
                            <button onclick="clearFileSelection()" class="mt-2 ml-2 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Template Download -->
            <div class="mb-6">
                <h4 class="text-lg font-bold mb-4 text-purple-700">üìã Modelo de Planilha</h4>
                <div class="bg-purple-50 p-4 rounded-lg mb-4">
                    <p class="text-sm text-purple-800 mb-2">
                        Baixe um modelo de planilha com a estrutura correta para importa√ß√£o:
                    </p>
                </div>
                <button onclick="downloadTemplate()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-medium">
                    üìã Baixar Modelo de Planilha
                </button>
            </div>

            <!-- Close Button -->
            <div class="flex justify-center">
                <button onclick="closeModal('exportModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Import Confirmation Modal -->
    <div id="importConfirmationModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 text-center">
            <h3 class="text-xl font-bold mb-4 text-green-700">‚úÖ Importa√ß√£o Processada</h3>
            <div class="bg-green-50 p-4 rounded-lg mb-6">
                <div class="text-lg font-medium text-green-800 mb-2">Dados Encontrados:</div>
                <div class="space-y-2 text-green-700">
                    <div id="professionalsCount">üë®‚Äç‚öïÔ∏è <span class="font-bold">0</span> profissionais adicionados</div>
                    <div id="appointmentsCount">üìÖ <span class="font-bold">0</span> agendamentos totais</div>
                </div>
            </div>
            <div class="text-sm text-gray-600 mb-6">
                Deseja aplicar estes dados ao sistema? Esta a√ß√£o substituir√° todos os dados existentes.
            </div>
            <div class="flex gap-3">
                <button onclick="confirmImport()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex-1">
                    ‚úÖ Aceitar
                </button>
                <button onclick="cancelImport()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex-1">
                    ‚ùå Recusar
                </button>
            </div>
        </div>
    </div>

    <!-- Conflict Resolution Modal -->
    <div id="conflictResolutionModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-5xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-center text-red-800">‚ö†Ô∏è Resolu√ß√£o de Conflitos de Agendamento</h3>
            
            <div class="mb-6 bg-red-50 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-red-800">üö® Conflitos Detectados</h4>
                <p class="text-sm text-red-700 mb-3">
                    Os seguintes agendamentos possuem conflitos que precisam ser resolvidos antes da substitui√ß√£o:
                </p>
                <div id="conflictsList" class="space-y-3">
                    <!-- Conflicts will be loaded here -->
                </div>
            </div>
            
            <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-blue-800">üí° Sugest√µes de Resolu√ß√£o</h4>
                <div id="resolutionSuggestions">
                    <!-- Suggestions will be loaded here -->
                </div>
            </div>
            
            <div class="flex justify-center gap-3">
                <button onclick="applyConflictResolutions()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium">
                    ‚úÖ Aplicar Resolu√ß√µes
                </button>
                <button onclick="closeModal('conflictResolutionModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Time Slot Options Modal -->
    <div id="timeSlotOptionsModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-5xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-center text-blue-800">üïê Op√ß√µes de Substitui√ß√£o por Hor√°rio</h3>
            
            <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                <div id="timeSlotHeader" class="font-bold text-blue-800 mb-3">
                    <!-- Header will be populated -->
                </div>
                <div class="text-sm text-blue-700">
                    Selecione o profissional que assumir√° este hor√°rio. A substitui√ß√£o cancelar√° o agendamento do profissional ausente e transferir√°/cancelar√° o agendamento atual do substituto.
                </div>
            </div>
            
            <div id="timeSlotOptionsContent" class="space-y-3">
                <!-- Options will be loaded here -->
            </div>
            
            <div class="flex justify-center gap-3 mt-6">
                <button onclick="closeModal('timeSlotOptionsModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Absence Options Modal -->
    <div id="absenceOptionsModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-6xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-center text-red-800">üö® Op√ß√µes de Substitui√ß√£o por Falta</h3>
            
            <div class="mb-6 bg-red-50 p-4 rounded-lg">
                <div id="absenceOptionsHeader" class="font-bold text-red-800 mb-3">
                    <!-- Header will be populated -->
                </div>
                <div class="text-sm text-red-700">
                    Selecione as substitui√ß√µes que deseja aplicar. O sistema priorizou automaticamente as melhores op√ß√µes.
                </div>
            </div>
            
            <div id="absenceOptionsContent" class="space-y-4">
                <!-- Options will be loaded here -->
            </div>
            
            <div class="flex justify-center gap-3 mt-6">
                <button onclick="applySelectedAbsenceReplacements()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium">
                    üö® Aplicar Substitui√ß√µes Selecionadas
                </button>
                <button onclick="selectAllAbsenceOptions()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                    ‚òëÔ∏è Selecionar Todas
                </button>
                <button onclick="deselectAllAbsenceOptions()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium">
                    ‚òê Desmarcar Todas
                </button>
                <button onclick="closeModal('absenceOptionsModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div id="bulkEditModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-center text-amber-800">‚úèÔ∏è Edi√ß√£o em Lote de Agendamentos</h3>
            
            <!-- Filters -->
            <div class="mb-6 bg-amber-50 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-amber-800">üîç Filtros de Busca</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Profissional:</label>
                        <select id="bulkFilterProfessional" onchange="filterBulkAppointments()" class="w-full p-2 border rounded focus:ring-2 focus:ring-amber-500">
                            <option value="">Todos os Profissionais</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tipo de Atendimento:</label>
                        <select id="bulkFilterType" onchange="filterBulkAppointments()" class="w-full p-2 border rounded focus:ring-2 focus:ring-amber-500">
                            <option value="">Todos os Tipos</option>
                            <option value="clinica">Atendimento Cl√≠nica</option>
                            <option value="analise">An√°lise</option>
                            <option value="discussao">Discuss√£o de Caso</option>
                            <option value="cls">CLS</option>
                            <option value="supervisao">Supervis√£o</option>
                            <option value="treinamento">Treinamento</option>
                            <option value="orientacao">Orienta√ß√£o Parental</option>
                            <option value="bloqueado">Hor√°rio Bloqueado</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Cliente:</label>
                        <input type="text" id="bulkFilterClient" placeholder="Nome do cliente..." onkeyup="filterBulkAppointments()" class="w-full p-2 border rounded focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <button onclick="clearBulkFilters()" class="text-amber-600 hover:text-amber-800 font-medium text-sm">
                        ‚úï Limpar Filtros
                    </button>
                </div>
            </div>
            
            <!-- Smart Professional Replacement -->
            <div class="mb-6 bg-purple-50 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-purple-800">üîÑ Substitui√ß√£o Inteligente de Profissional</h4>
                <div class="mb-3 bg-purple-100 p-3 rounded-lg">
                    <p class="text-sm text-purple-800 mb-1">
                        <strong>üìã Tipos de Agendamento Considerados:</strong>
                    </p>
                    <ul class="text-sm text-purple-700 space-y-1 ml-4">
                        <li>‚úÖ <strong>Atendimento Cl√≠nica</strong> - Podem ser transferidos</li>
                        <li>‚úÖ <strong>Discuss√£o de Caso</strong> - Podem ser transferidos</li>
                        <li>‚ùå <strong>CLS, An√°lise, Supervis√£o, Treinamento, Bloqueados</strong> - N√£o s√£o considerados</li>
                    </ul>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Profissional que est√° saindo:</label>
                        <select id="leavingProfessional" onchange="analyzeProfessionalReplacement()" class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-500">
                            <option value="">Selecione o profissional...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Novo profissional substituto:</label>
                        <select id="replacementProfessional" onchange="checkReplacementCompatibility()" class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-500">
                            <option value="">Selecione o substituto...</option>
                        </select>
                    </div>
                </div>
                
                <!-- Analysis Results -->
                <div id="replacementAnalysis" class="mt-4 hidden">
                    <div class="bg-white p-4 rounded-lg border">
                        <h5 class="font-bold mb-3 text-gray-800">üìä An√°lise de Substitui√ß√£o</h5>
                        <div id="analysisResults"></div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="executeSmartReplacement()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-medium">
                                üîÑ Executar Substitui√ß√£o Inteligente
                            </button>
                            <button onclick="showConflictResolution()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded font-medium">
                                ‚ö†Ô∏è Resolver Conflitos
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Absence Replacement -->
            <div class="mb-6 bg-red-50 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-red-800">üö® Substitui√ß√£o por Falta de Profissional</h4>
                <div class="mb-4 bg-red-100 p-3 rounded-lg">
                    <p class="text-sm text-red-800 mb-2">
                        <strong>Sistema Inteligente de Prioridades:</strong>
                    </p>
                    <ul class="text-sm text-red-700 space-y-1 ml-4">
                        <li>ü•á <strong>1¬™ Prioridade:</strong> Profissionais com CLS no mesmo hor√°rio</li>
                        <li>ü•à <strong>2¬™ Prioridade:</strong> Profissionais com An√°lise no mesmo hor√°rio</li>
                        <li>ü•â <strong>3¬™ Prioridade:</strong> Profissionais com Supervis√£o no mesmo hor√°rio</li>
                        <li>üèÖ <strong>4¬™ Prioridade:</strong> Profissionais com Discuss√£o de Caso no mesmo hor√°rio</li>
                        <li>üìã <strong>√öltima op√ß√£o:</strong> Profissionais totalmente livres no hor√°rio</li>
                    </ul>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Profissional que faltou:</label>
                        <select id="absentProfessional" onchange="analyzeAbsenceReplacement()" class="w-full p-2 border rounded focus:ring-2 focus:ring-red-500">
                            <option value="">Selecione o profissional...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Dia da semana da falta:</label>
                        <select id="absenceDay" onchange="analyzeAbsenceReplacement()" class="w-full p-2 border rounded focus:ring-2 focus:ring-red-500">
                            <option value="">Selecione o dia...</option>
                            <option value="1">Segunda-feira</option>
                            <option value="2">Ter√ßa-feira</option>
                            <option value="3">Quarta-feira</option>
                            <option value="4">Quinta-feira</option>
                            <option value="5">Sexta-feira</option>
                            <option value="6">S√°bado</option>
                        </select>
                    </div>
                </div>
                
                <!-- Absence Analysis Results -->
                <div id="absenceAnalysis" class="mt-4 hidden">
                    <div class="bg-white p-4 rounded-lg border">
                        <h5 class="font-bold mb-3 text-gray-800">üîç An√°lise de Disponibilidade por Prioridade</h5>
                        <div id="absenceResults"></div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="executeAbsenceReplacement()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium">
                                üö® Executar Substitui√ß√µes de Emerg√™ncia
                            </button>
                            <button onclick="showAbsenceOptions()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium">
                                üëÅÔ∏è Ver Todas as Op√ß√µes
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-blue-800">‚ö° A√ß√µes em Lote</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Alterar Tipo para:</label>
                        <select id="bulkChangeType" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione um tipo...</option>
                            <option value="clinica">Atendimento Cl√≠nica</option>
                            <option value="analise">An√°lise</option>
                            <option value="discussao">Discuss√£o de Caso</option>
                            <option value="cls">CLS</option>
                            <option value="supervisao">Supervis√£o</option>
                            <option value="treinamento">Treinamento</option>
                            <option value="orientacao">Orienta√ß√£o Parental</option>
                            <option value="bloqueado">Hor√°rio Bloqueado</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Alterar Profissional para:</label>
                        <select id="bulkChangeProfessional" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione um profissional...</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex gap-2">
                    <button onclick="applyBulkChanges()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium">
                        ‚úÖ Aplicar aos Selecionados
                    </button>
                    <button onclick="selectAllFiltered()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium">
                        ‚òëÔ∏è Selecionar Todos
                    </button>
                    <button onclick="deselectAll()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-medium">
                        ‚òê Desmarcar Todos
                    </button>
                    <button onclick="deleteBulkSelected()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium">
                        üóëÔ∏è Excluir Selecionados
                    </button>
                </div>
            </div>
            
            <!-- Appointments List -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-gray-800">üìã Agendamentos Encontrados</h4>
                    <span id="bulkResultsCount" class="text-sm text-gray-600">0 agendamentos</span>
                </div>
                <div id="bulkAppointmentsList" class="max-h-96 overflow-y-auto border rounded-lg">
                    <!-- Appointments will be loaded here -->
                </div>
            </div>
            
            <!-- Close Button -->
            <div class="flex justify-center">
                <button onclick="closeModal('bulkEditModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4" id="scheduleModalTitle">Agendar Consulta</h3>
            <form onsubmit="saveAppointment(event)">
                <input type="hidden" id="appointmentId">
                <input type="hidden" id="appointmentDate">
                <input type="hidden" id="appointmentTime">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Profissional:</label>
                    <select id="appointmentProfessional" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione o profissional...</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Cliente:</label>
                    <input type="text" id="clientName" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Tipo de Atendimento:</label>
                    <select id="appointmentType" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="clinica">Atendimento Cl√≠nica</option>
                        <option value="analise">An√°lise</option>
                        <option value="discussao">Discuss√£o de Caso</option>
                        <option value="cls">CLS</option>
                        <option value="supervisao">Supervis√£o</option>
                        <option value="treinamento">Treinamento</option>
                        <option value="orientacao">Orienta√ß√£o Parental</option>
                        <option value="bloqueado">Hor√°rio Bloqueado</option>
                    </select>
                </div>
                

                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Hor√°rio:</label>
                    <select id="appointmentTimeInput" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione o hor√°rio...</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Observa√ß√µes:</label>
                    <textarea id="observations" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium flex-1">
                        Salvar
                    </button>
                    <button type="button" onclick="closeModal('scheduleModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">
                        Cancelar
                    </button>
                    <button type="button" id="deleteAppointmentBtn" onclick="deleteAppointment()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium" style="display: none;">
                        Excluir
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal active">
        <div class="bg-white rounded-lg p-8 w-full max-w-md mx-4">
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">üîê</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Sistema de Agendamento</h2>
                <p class="text-gray-600">Cl√≠nica ABA - Acesso Restrito</p>
            </div>
            
            <form onsubmit="performLogin(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">üë§ Usu√°rio:</label>
                    <input type="text" id="loginUsername" required 
                           class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="Digite seu usu√°rio">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">üîë Senha:</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="Digite sua senha">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium mb-4">
                    üö™ Entrar no Sistema
                </button>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-2">üìã N√≠veis de Acesso:</h4>
                    <div class="text-sm text-gray-600 space-y-1">
                        <div><strong>üëë Administrador:</strong> Acesso total + exclus√µes</div>
                        <div><strong>‚úèÔ∏è Editor:</strong> Criar e editar (sem excluir)</div>
                        <div><strong>üëÅÔ∏è Visualizador:</strong> Apenas visualizar</div>
                    </div>
                </div>
                
                <div id="loginError" class="mt-4 p-3 bg-red-50 text-red-700 rounded-lg hidden">
                    ‚ùå Usu√°rio ou senha incorretos!
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let professionals = JSON.parse(localStorage.getItem('professionals') || '[]');
        let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
        let currentWeek = new Date();
        let currentView = 'schedule';
        let selectedProfessional = '';
        
        // Hidden system reset variables
        let resetSequence = [];
        let resetSequenceTarget = ['professionals', 'professionals', 'professionals', 'professionals', 'professionals'];
        let resetSequenceTimeout = null;

        // User authentication system
        let currentUser = null;
        let userPermissions = null;

        // User database with different access levels
        const users = {
            // Administrators - Full access including deletions
            'admin': { password: 'admin123', level: 'admin', name: 'Administrador' },
            'diretor': { password: 'diretor2024', level: 'admin', name: 'Diretor' },
            'coordenador': { password: 'coord2024', level: 'admin', name: 'Coordenador' },
            
            // Editors - Can create and edit, but not delete
            'secretaria': { password: 'sec2024', level: 'editor', name: 'Secret√°ria' },
            'recepcionista': { password: 'recep2024', level: 'editor', name: 'Recepcionista' },
            'supervisor': { password: 'super2024', level: 'editor', name: 'Supervisor' },
            
            // Viewers - Read-only access
            'terapeuta': { password: 'tera2024', level: 'viewer', name: 'Terapeuta' },
            'estagiario': { password: 'estag2024', level: 'viewer', name: 'Estagi√°rio' },
            'consultor': { password: 'cons2024', level: 'viewer', name: 'Consultor' }
        };

        // Permission definitions
        const permissions = {
            admin: {
                canView: true,
                canCreate: true,
                canEdit: true,
                canDelete: true,
                canExport: true,
                canImport: true,
                canBulkEdit: true,
                canSystemReset: true,
                canManageProfessionals: true
            },
            editor: {
                canView: true,
                canCreate: true,
                canEdit: true,
                canDelete: false,
                canExport: true,
                canImport: true,
                canBulkEdit: true,
                canSystemReset: false,
                canManageProfessionals: true
            },
            viewer: {
                canView: true,
                canCreate: false,
                canEdit: false,
                canDelete: false,
                canExport: true,
                canImport: false,
                canBulkEdit: false,
                canSystemReset: false,
                canManageProfessionals: false
            }
        };

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        // Authentication functions
        function checkAuthentication() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                if (users[userData.username] && users[userData.username].password === userData.password) {
                    currentUser = userData;
                    userPermissions = permissions[users[userData.username].level];
                    initializeSystem();
                    return;
                }
            }
            
            // Show login modal if not authenticated
            document.getElementById('loginModal').classList.add('active');
        }

        function performLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.toLowerCase();
            const password = document.getElementById('loginPassword').value;
            
            if (users[username] && users[username].password === password) {
                // Successful login
                currentUser = {
                    username: username,
                    password: password,
                    level: users[username].level,
                    name: users[username].name
                };
                
                userPermissions = permissions[users[username].level];
                
                // Save login state
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Hide login modal and initialize system
                document.getElementById('loginModal').classList.remove('active');
                initializeSystem();
                
                // Show welcome message
                showWelcomeMessage();
                
            } else {
                // Failed login
                document.getElementById('loginError').classList.remove('hidden');
                document.getElementById('loginPassword').value = '';
                
                // Hide error after 3 seconds
                setTimeout(() => {
                    document.getElementById('loginError').classList.add('hidden');
                }, 3000);
            }
        }

        function showWelcomeMessage() {
            const levelIcons = {
                admin: 'üëë',
                editor: '‚úèÔ∏è',
                viewer: 'üëÅÔ∏è'
            };
            
            const levelNames = {
                admin: 'Administrador',
                editor: 'Editor',
                viewer: 'Visualizador'
            };
            
            const message = `${levelIcons[currentUser.level]} Bem-vindo, ${currentUser.name}!\nN√≠vel: ${levelNames[currentUser.level]}`;
            showSuccessMessage(message);
        }

        function logout() {
            if (confirm('üö™ Deseja realmente sair do sistema?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                userPermissions = null;
                
                // Clear sensitive data
                document.getElementById('scheduleGrid').innerHTML = '';
                document.getElementById('weeklyScheduleGrid').innerHTML = '';
                document.getElementById('professionalsList').innerHTML = '';
                
                // Show login modal
                document.getElementById('loginModal').classList.add('active');
                
                // Reset form
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').classList.add('hidden');
            }
        }

        function initializeSystem() {
            loadScheduleGrid();
            updateProfessionalFilter();
            populateTimeSlots();
            updateUIBasedOnPermissions();
            updateHeaderWithUserInfo();
        }

        function updateHeaderWithUserInfo() {
            const headerDiv = document.querySelector('.bg-white.rounded-lg.shadow-lg.p-3.mb-3');
            
            // Remove existing user info if present
            const existingUserInfo = headerDiv.querySelector('.user-info');
            if (existingUserInfo) {
                existingUserInfo.remove();
            }
            
            // Add user info
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info flex justify-between items-center mb-3 bg-blue-50 p-3 rounded-lg';
            
            const levelIcons = {
                admin: 'üëë',
                editor: '‚úèÔ∏è',
                viewer: 'üëÅÔ∏è'
            };
            
            const levelNames = {
                admin: 'Administrador',
                editor: 'Editor',
                viewer: 'Visualizador'
            };
            
            const levelColors = {
                admin: 'text-red-600',
                editor: 'text-blue-600',
                viewer: 'text-green-600'
            };
            
            userInfo.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">${levelIcons[currentUser.level]}</span>
                    <div>
                        <div class="font-bold ${levelColors[currentUser.level]}">${currentUser.name}</div>
                        <div class="text-sm text-gray-600">N√≠vel: ${levelNames[currentUser.level]}</div>
                    </div>
                </div>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm font-medium transition-colors">
                    üö™ Sair
                </button>
            `;
            
            // Insert after the title
            const title = headerDiv.querySelector('h1');
            title.parentNode.insertBefore(userInfo, title.nextSibling);
        }

        function updateUIBasedOnPermissions() {
            // Get all action buttons
            const buttons = document.querySelectorAll('button');
            
            buttons.forEach(button => {
                const buttonText = button.textContent.toLowerCase();
                
                // Hide/show buttons based on permissions
                if (buttonText.includes('cadastrar') && !userPermissions.canCreate) {
                    button.style.display = 'none';
                }
                
                if (buttonText.includes('agendar') && !userPermissions.canCreate) {
                    button.style.display = 'none';
                }
                
                if (buttonText.includes('excel') && !userPermissions.canExport) {
                    button.style.display = 'none';
                }
                
                if (buttonText.includes('edi√ß√£o em lote') && !userPermissions.canBulkEdit) {
                    button.style.display = 'none';
                }
                
                if (buttonText.includes('profissionais') && !userPermissions.canView) {
                    button.style.display = 'none';
                }
            });
            
            // Always hide reset button initially - only admins can see it through sequence
            const resetButton = document.getElementById('hiddenResetButton');
            if (resetButton) {
                resetButton.style.display = 'none';
            }
            
            // Update professional cards based on permissions
            updateProfessionalCardsPermissions();
        }

        function updateProfessionalCardsPermissions() {
            // This will be called when professional cards are loaded
            setTimeout(() => {
                const deleteButtons = document.querySelectorAll('button[onclick*="deleteProfessional"]');
                deleteButtons.forEach(button => {
                    if (!userPermissions.canDelete) {
                        button.style.display = 'none';
                    }
                });
            }, 100);
        }

        // Override functions to check permissions
        function checkPermission(action) {
            switch(action) {
                case 'create':
                    return userPermissions.canCreate;
                case 'edit':
                    return userPermissions.canEdit;
                case 'delete':
                    return userPermissions.canDelete;
                case 'export':
                    return userPermissions.canExport;
                case 'import':
                    return userPermissions.canImport;
                case 'bulkEdit':
                    return userPermissions.canBulkEdit;
                case 'systemReset':
                    return userPermissions.canSystemReset;
                case 'manageProfessionals':
                    return userPermissions.canManageProfessionals;
                default:
                    return false;
            }
        }

        function showPermissionDenied(action) {
            const actionNames = {
                create: 'criar',
                edit: 'editar',
                delete: 'excluir',
                export: 'exportar',
                import: 'importar',
                bulkEdit: 'edi√ß√£o em lote',
                systemReset: 'resetar sistema',
                manageProfessionals: 'gerenciar profissionais'
            };
            
            const levelNames = {
                admin: 'Administrador',
                editor: 'Editor',
                viewer: 'Visualizador'
            };
            
            alert(`üö´ ACESSO NEGADO\n\nVoc√™ n√£o tem permiss√£o para ${actionNames[action]}.\n\nSeu n√≠vel atual: ${levelNames[currentUser.level]}\n\nContate um administrador se precisar de mais permiss√µes.`);
        }

        // View Management
        function showScheduleView() {
            hideAllViews();
            document.getElementById('scheduleView').style.display = 'block';
            currentView = 'schedule';
            loadScheduleGrid();
        }

        function showProfessionalsView() {
            if (!checkPermission('manageProfessionals')) {
                showPermissionDenied('manageProfessionals');
                return;
            }
            hideAllViews();
            document.getElementById('professionalsView').style.display = 'block';
            currentView = 'professionals';
            loadProfessionalsList();
        }

        function showReports() {
            hideAllViews();
            document.getElementById('reportsView').style.display = 'block';
            currentView = 'reports';
            generateReports();
        }

        function showWeeklyView() {
            hideAllViews();
            document.getElementById('weeklyView').style.display = 'block';
            currentView = 'weekly';
            updateWeeklyProfessionalFilter();
            loadWeeklyScheduleGrid();
        }

        function hideAllViews() {
            document.getElementById('scheduleView').style.display = 'none';
            document.getElementById('professionalsView').style.display = 'none';
            document.getElementById('reportsView').style.display = 'none';
            document.getElementById('weeklyView').style.display = 'none';
        }

        // Professional Management
        function openProfessionalModal() {
            if (!checkPermission('create')) {
                showPermissionDenied('create');
                return;
            }
            document.getElementById('professionalModal').classList.add('active');
        }

        function saveProfessional(event) {
            event.preventDefault();
            
            if (!checkPermission('create')) {
                showPermissionDenied('create');
                return;
            }
            
            const professional = {
                id: Date.now().toString(),
                name: document.getElementById('profName').value,
                specialty: document.getElementById('profSpecialty').value,
                color: document.getElementById('profColor').value,
                active: true
            };
            
            professionals.push(professional);
            localStorage.setItem('professionals', JSON.stringify(professionals));
            
            updateProfessionalFilter();
            updateAppointmentProfessionals();
            closeModal('professionalModal');
            
            // Reset form
            document.getElementById('profName').value = '';
            document.getElementById('profSpecialty').value = '';
            document.getElementById('profColor').value = 'bg-blue-500';
            
            if (currentView === 'professionals') {
                loadProfessionalsList();
            }
        }

        function loadProfessionalsList() {
            const container = document.getElementById('professionalsList');
            container.innerHTML = '';
            
            if (professionals.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">üë®‚Äç‚öïÔ∏è</div>
                        <h3 class="text-xl font-medium text-gray-600 mb-2">Nenhum profissional cadastrado</h3>
                        <p class="text-gray-500 mb-4">Comece cadastrando seu primeiro profissional</p>
                        ${userPermissions.canCreate ? `
                            <button onclick="openProfessionalModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium">
                                üë®‚Äç‚öïÔ∏è Cadastrar Primeiro Profissional
                            </button>
                        ` : ''}
                    </div>
                `;
                return;
            }
            
            // Separate active and inactive professionals
            const activeProfessionals = professionals.filter(prof => prof.active !== false);
            const inactiveProfessionals = professionals.filter(prof => prof.active === false);
            
            // Active professionals section
            if (activeProfessionals.length > 0) {
                const activeHeader = document.createElement('div');
                activeHeader.className = 'col-span-full mb-4';
                activeHeader.innerHTML = `
                    <h3 class="text-xl font-bold text-green-800 mb-2 flex items-center">
                        ‚úÖ Profissionais Ativos (${activeProfessionals.length})
                    </h3>
                    <div class="h-1 bg-green-200 rounded"></div>
                `;
                container.appendChild(activeHeader);
                
                activeProfessionals.forEach(prof => {
                    const card = createProfessionalCard(prof, true);
                    container.appendChild(card);
                });
            }
            
            // Inactive professionals section
            if (inactiveProfessionals.length > 0) {
                const inactiveHeader = document.createElement('div');
                inactiveHeader.className = 'col-span-full mb-4 mt-8';
                inactiveHeader.innerHTML = `
                    <h3 class="text-xl font-bold text-red-800 mb-2 flex items-center">
                        ‚ùå Profissionais Inativos (${inactiveProfessionals.length})
                    </h3>
                    <div class="h-1 bg-red-200 rounded"></div>
                `;
                container.appendChild(inactiveHeader);
                
                inactiveProfessionals.forEach(prof => {
                    const card = createProfessionalCard(prof, false);
                    container.appendChild(card);
                });
            }
            
            // Update permissions after loading
            updateProfessionalCardsPermissions();
        }

        function createProfessionalCard(prof, isActive) {
            const card = document.createElement('div');
            card.className = `professional-card bg-white rounded-lg shadow-md p-4 border-l-4 ${prof.color.replace('bg-', 'border-')} ${!isActive ? 'opacity-60' : ''}`;
            
            let buttonsHtml = '';
            
            if (userPermissions.canView) {
                buttonsHtml += `
                    <button onclick="viewProfessionalSchedule('${prof.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm flex-1">
                        Ver Agenda
                    </button>
                `;
            }
            
            if (userPermissions.canEdit) {
                if (isActive) {
                    buttonsHtml += `
                        <button onclick="toggleProfessionalStatus('${prof.id}', false)" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded text-sm ml-2">
                            Inativar
                        </button>
                    `;
                } else {
                    buttonsHtml += `
                        <button onclick="toggleProfessionalStatus('${prof.id}', true)" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm ml-2">
                            Ativar
                        </button>
                    `;
                }
            }
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center">
                        <h3 class="font-bold text-gray-800 text-lg">${prof.name}</h3>
                        <span class="ml-3 px-2 py-1 rounded text-xs ${isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${isActive ? '‚úÖ Ativo' : '‚ùå Inativo'}
                        </span>
                    </div>
                    ${userPermissions.canDelete ? `
                        <button onclick="deleteProfessional('${prof.id}')" class="text-red-500 hover:text-red-700 text-lg delete-professional-btn">
                            üóëÔ∏è
                        </button>
                    ` : ''}
                </div>
                <p class="text-gray-600 mb-3">${prof.specialty}</p>
                <div class="flex gap-2">
                    ${buttonsHtml}
                </div>
            `;
            
            return card;
        }

        function toggleProfessionalStatus(id, newStatus) {
            if (!checkPermission('edit')) {
                showPermissionDenied('edit');
                return;
            }
            
            const professional = professionals.find(p => p.id === id);
            if (!professional) return;
            
            const action = newStatus ? 'ativar' : 'inativar';
            const statusText = newStatus ? 'ativo' : 'inativo';
            
            let confirmMessage = `üîÑ ALTERAR STATUS DO PROFISSIONAL\n\n`;
            confirmMessage += `Profissional: ${professional.name}\n`;
            confirmMessage += `A√ß√£o: ${action.toUpperCase()}\n\n`;
            
            if (!newStatus) {
                // Inactivating - show what will happen
                const professionalAppointments = appointments.filter(apt => apt.professionalId === id);
                confirmMessage += `‚ö†Ô∏è ATEN√á√ÉO:\n`;
                confirmMessage += `‚Ä¢ O profissional ficar√° OCULTO do sistema operacional\n`;
                confirmMessage += `‚Ä¢ N√£o aparecer√° em filtros, agendamentos ou sele√ß√µes\n`;
                confirmMessage += `‚Ä¢ ${professionalAppointments.length} agendamentos existentes ser√£o MANTIDOS\n`;
                confirmMessage += `‚Ä¢ Dados hist√≥ricos ser√£o PRESERVADOS\n`;
                confirmMessage += `‚Ä¢ Pode ser reativado a qualquer momento\n\n`;
                confirmMessage += `üí° Use "Inativar" em vez de "Excluir" para preservar dados\n\n`;
            } else {
                // Activating
                confirmMessage += `‚úÖ O profissional voltar√° a aparecer em:\n`;
                confirmMessage += `‚Ä¢ Filtros de agenda\n`;
                confirmMessage += `‚Ä¢ Sele√ß√£o para novos agendamentos\n`;
                confirmMessage += `‚Ä¢ Todas as funcionalidades do sistema\n\n`;
            }
            
            confirmMessage += `Deseja ${action} ${professional.name}?`;
            
            if (confirm(confirmMessage)) {
                const index = professionals.findIndex(p => p.id === id);
                if (index !== -1) {
                    professionals[index].active = newStatus;
                    localStorage.setItem('professionals', JSON.stringify(professionals));
                    
                    // Update UI
                    updateProfessionalFilter();
                    updateAppointmentProfessionals();
                    loadProfessionalsList();
                    loadScheduleGrid();
                    loadWeeklyScheduleGrid();
                    
                    const actionPast = newStatus ? 'ativado' : 'inativado';
                    showSuccessMessage(`‚úÖ ${professional.name} foi ${actionPast} com sucesso!`);
                }
            }
        }

        function deleteProfessional(id) {
            if (!checkPermission('delete')) {
                showPermissionDenied('delete');
                return;
            }
            
            const professional = professionals.find(p => p.id === id);
            if (!professional) return;
            
            const professionalAppointments = appointments.filter(apt => apt.professionalId === id);
            
            let confirmMessage = `üóëÔ∏è CONFIRMAR EXCLUS√ÉO PERMANENTE\n\n`;
            confirmMessage += `üë®‚Äç‚öïÔ∏è Profissional: ${professional.name}\n`;
            confirmMessage += `üè• Especialidade: ${professional.specialty}\n`;
            confirmMessage += `üìä Status: ${professional.active !== false ? 'Ativo' : 'Inativo'}\n\n`;
            
            confirmMessage += `üìÖ AGENDAMENTOS QUE SER√ÉO PERDIDOS:\n`;
            if (professionalAppointments.length === 0) {
                confirmMessage += `‚úÖ Nenhum agendamento ser√° perdido\n\n`;
            } else {
                confirmMessage += `‚ö†Ô∏è ${professionalAppointments.length} agendamentos ser√£o PERMANENTEMENTE exclu√≠dos:\n\n`;
                
                // Show up to 5 appointments + count
                const displayAppointments = professionalAppointments.slice(0, 5);
                displayAppointments.forEach(apt => {
                    const date = new Date(apt.date).toLocaleDateString('pt-BR');
                    confirmMessage += `‚Ä¢ ${date} √†s ${apt.time} - ${apt.clientName} (${getTypeLabel(apt.type)})\n`;
                });
                
                if (professionalAppointments.length > 5) {
                    confirmMessage += `‚Ä¢ ... e mais ${professionalAppointments.length - 5} agendamentos\n`;
                }
                confirmMessage += `\n`;
            }
            
            confirmMessage += `üí° ALTERNATIVA RECOMENDADA:\n`;
            confirmMessage += `Use "INATIVAR" em vez de "EXCLUIR" para:\n`;
            confirmMessage += `‚Ä¢ Ocultar do sistema sem perder dados\n`;
            confirmMessage += `‚Ä¢ Preservar hist√≥rico de agendamentos\n`;
            confirmMessage += `‚Ä¢ Possibilitar reativa√ß√£o futura\n\n`;
            
            confirmMessage += `‚ö†Ô∏è ATEN√á√ÉO: EXCLUS√ÉO √â PERMANENTE E IRREVERS√çVEL!\n\n`;
            confirmMessage += `Tem CERTEZA que deseja EXCLUIR permanentemente?`;
            
            if (confirm(confirmMessage)) {
                // Final confirmation for deletion
                const finalConfirm = confirm(`üö® √öLTIMA CONFIRMA√á√ÉO\n\nEsta √© sua √∫ltima chance de cancelar!\n\nExcluir permanentemente ${professional.name} e ${professionalAppointments.length} agendamentos?\n\n‚ö†Ô∏è ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!`);
                
                if (finalConfirm) {
                    professionals = professionals.filter(p => p.id !== id);
                    appointments = appointments.filter(a => a.professionalId !== id);
                    
                    localStorage.setItem('professionals', JSON.stringify(professionals));
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    
                    updateProfessionalFilter();
                    updateAppointmentProfessionals();
                    loadProfessionalsList();
                    loadScheduleGrid();
                    loadWeeklyScheduleGrid();
                    
                    showSuccessMessage(`üóëÔ∏è ${professional.name} foi exclu√≠do permanentemente junto com ${professionalAppointments.length} agendamentos.`);
                }
            }
        }

        function viewProfessionalSchedule(professionalId) {
            selectedProfessional = professionalId;
            document.getElementById('professionalFilter').value = professionalId;
            showScheduleView();
            loadScheduleGrid();
        }

        // Schedule Management
        function loadScheduleGrid() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            
            // Create time slots from 7:00 to 19:00 (hourly intervals only)
            const timeSlots = [];
            for (let hour = 7; hour <= 19; hour++) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
            }
            
            // Get week days (Monday to Saturday only - skip Sunday)
            const weekDays = getWeekDays(currentWeek).slice(1, 7); // Skip Sunday (index 0)
            const dayNames = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            
            // Update grid template to 6 columns + 1 for time labels (no Sunday)
            grid.style.gridTemplateColumns = '80px repeat(6, 1fr)';
            
            // Create headers
            grid.appendChild(createTimeLabel(''));
            dayNames.forEach(dayName => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = dayName;
                grid.appendChild(header);
            });
            
            // Create time slots
            timeSlots.forEach(time => {
                // Time label
                grid.appendChild(createTimeLabel(time));
                
                // Day slots (6 days - Monday to Saturday)
                for (let dayIndex = 0; dayIndex < 6; dayIndex++) {
                    const slot = createTimeSlot(weekDays[dayIndex], time);
                    grid.appendChild(slot);
                }
            });
        }

        function createTimeLabel(time) {
            const label = document.createElement('div');
            label.className = 'time-label';
            label.textContent = time;
            return label;
        }

        function createTimeSlot(date, time) {
            const slot = document.createElement('div');
            slot.className = 'time-slot appointment-slot';
            
            const dateStr = formatDate(date);
            const appointment = appointments.find(a => 
                a.date === dateStr && 
                a.time === time && 
                (!selectedProfessional || a.professionalId === selectedProfessional)
            );
            
            if (appointment) {
                slot.className += ' ' + getAppointmentColor(appointment.type);
                if (appointment.type === 'bloqueado') {
                    slot.className += ' blocked-slot';
                }
                slot.innerHTML = `
                    <div class="font-medium truncate" style="font-size: 9px;">${appointment.clientName}</div>
                    <div class="opacity-75 truncate" style="font-size: 8px;">${getTypeLabel(appointment.type)}</div>
                `;
                slot.onclick = () => editAppointment(appointment);
            } else {
                slot.onclick = () => newAppointment(dateStr, time);
            }
            
            return slot;
        }

        function getAppointmentColor(type) {
            const colors = {
                'clinica': 'bg-orange-200 text-orange-800',
                'analise': 'bg-pink-200 text-pink-800',
                'discussao': 'bg-blue-200 text-blue-800',
                'cls': 'bg-green-200 text-green-800',
                'supervisao': 'bg-yellow-100 text-yellow-800 border border-gray-300',
                'treinamento': 'bg-purple-200 text-purple-800',
                'orientacao': 'bg-yellow-200 text-yellow-800',
                'bloqueado': 'bg-gray-200 text-gray-800'
            };
            return colors[type] || 'bg-gray-200 text-gray-800';
        }

        function getTypeLabel(type) {
            const labels = {
                'clinica': 'Cl√≠nica',
                'analise': 'An√°lise',
                'discussao': 'Discuss√£o',
                'cls': 'CLS',
                'supervisao': 'Supervis√£o',
                'treinamento': 'Treinamento',
                'orientacao': 'Orient. Parental',
                'bloqueado': 'Bloqueado'
            };
            return labels[type] || type;
        }

        // Appointment Management
        function openScheduleModal() {
            if (!checkPermission('create')) {
                showPermissionDenied('create');
                return;
            }
            document.getElementById('scheduleModalTitle').textContent = 'Agendar Consulta';
            document.getElementById('appointmentId').value = '';
            document.getElementById('deleteAppointmentBtn').style.display = 'none';
            clearScheduleForm();
            document.getElementById('scheduleModal').classList.add('active');
        }

        function newAppointment(date, time) {
            if (!checkPermission('create')) {
                showPermissionDenied('create');
                return;
            }
            document.getElementById('scheduleModalTitle').textContent = 'Novo Agendamento';
            document.getElementById('appointmentId').value = '';
            document.getElementById('appointmentDate').value = date;
            document.getElementById('appointmentTime').value = time;
            document.getElementById('appointmentDateInput').value = date;
            document.getElementById('appointmentTimeInput').value = time;
            document.getElementById('deleteAppointmentBtn').style.display = 'none';
            clearScheduleForm();
            document.getElementById('scheduleModal').classList.add('active');
        }

        function editAppointment(appointment) {
            if (!checkPermission('edit')) {
                showPermissionDenied('edit');
                return;
            }
            document.getElementById('scheduleModalTitle').textContent = 'Editar Agendamento';
            document.getElementById('appointmentId').value = appointment.id;
            document.getElementById('appointmentDate').value = appointment.date;
            document.getElementById('appointmentTime').value = appointment.time;
            document.getElementById('appointmentProfessional').value = appointment.professionalId;
            document.getElementById('clientName').value = appointment.clientName;
            document.getElementById('appointmentType').value = appointment.type;
            document.getElementById('appointmentTimeInput').value = appointment.time;
            document.getElementById('observations').value = appointment.observations || '';
            
            // Show delete button only if user has delete permission
            if (userPermissions.canDelete) {
                document.getElementById('deleteAppointmentBtn').style.display = 'block';
            } else {
                document.getElementById('deleteAppointmentBtn').style.display = 'none';
            }
            
            // Show additional edit options for imported appointments
            showEditOptions(appointment);
            
            document.getElementById('scheduleModal').classList.add('active');
        }

        function saveAppointment(event) {
            event.preventDefault();
            
            const appointmentId = document.getElementById('appointmentId').value;
            const isEditing = !!appointmentId;
            
            if (isEditing && !checkPermission('edit')) {
                showPermissionDenied('edit');
                return;
            }
            
            if (!isEditing && !checkPermission('create')) {
                showPermissionDenied('create');
                return;
            }
            
            const newDate = document.getElementById('appointmentDate').value;
            const newTime = document.getElementById('appointmentTimeInput').value;
            const newProfessionalId = document.getElementById('appointmentProfessional').value;
            
            // Check for conflicts when changing date/time/professional
            if (appointmentId) {
                const existingAppointment = appointments.find(a => a.id === appointmentId);
                const isDateTimeChanged = existingAppointment.date !== newDate || 
                                        existingAppointment.time !== newTime ||
                                        existingAppointment.professionalId !== newProfessionalId;
                
                if (isDateTimeChanged) {
                    const conflict = appointments.find(a => 
                        a.id !== appointmentId &&
                        a.date === newDate && 
                        a.time === newTime && 
                        a.professionalId === newProfessionalId
                    );
                    
                    if (conflict) {
                        const professional = professionals.find(p => p.id === newProfessionalId);
                        const profName = professional ? professional.name : 'Profissional';
                        
                        if (!confirm(`‚ö†Ô∏è CONFLITO DETECTADO!\n\nJ√° existe um agendamento para ${profName} em ${newDate} √†s ${newTime}.\n\nCliente: ${conflict.clientName}\nTipo: ${getTypeLabel(conflict.type)}\n\nDeseja substituir o agendamento existente?`)) {
                            return;
                        }
                        
                        // Remove conflicting appointment
                        appointments = appointments.filter(a => a.id !== conflict.id);
                    }
                }
            }
            
            const appointment = {
                id: appointmentId || Date.now().toString(),
                professionalId: newProfessionalId,
                date: newDate,
                time: newTime,
                clientName: document.getElementById('clientName').value,
                type: document.getElementById('appointmentType').value,
                observations: document.getElementById('observations').value
            };
            
            if (appointmentId) {
                // Update existing
                const index = appointments.findIndex(a => a.id === appointmentId);
                if (index !== -1) {
                    appointments[index] = appointment;
                }
            } else {
                // Check for conflicts in new appointments
                const conflict = appointments.find(a => 
                    a.date === appointment.date && 
                    a.time === appointment.time && 
                    a.professionalId === appointment.professionalId
                );
                
                if (conflict) {
                    const professional = professionals.find(p => p.id === appointment.professionalId);
                    const profName = professional ? professional.name : 'Profissional';
                    
                    if (!confirm(`‚ö†Ô∏è CONFLITO DETECTADO!\n\nJ√° existe um agendamento para ${profName} em ${appointment.date} √†s ${appointment.time}.\n\nCliente: ${conflict.clientName}\nTipo: ${getTypeLabel(conflict.type)}\n\nDeseja substituir o agendamento existente?`)) {
                        return;
                    }
                    
                    // Remove conflicting appointment
                    appointments = appointments.filter(a => a.id !== conflict.id);
                }
                
                // Add new
                appointments.push(appointment);
            }
            
            localStorage.setItem('appointments', JSON.stringify(appointments));
            loadScheduleGrid();
            loadWeeklyScheduleGrid(); // Update weekly view if active
            closeModal('scheduleModal');
            
            // Show success message
            const action = appointmentId ? 'atualizado' : 'criado';
            showSuccessMessage(`‚úÖ Agendamento ${action} com sucesso!`);
        }

        function deleteAppointment() {
            if (!checkPermission('delete')) {
                showPermissionDenied('delete');
                return;
            }
            
            const appointmentId = document.getElementById('appointmentId').value;
            const appointment = appointments.find(a => a.id === appointmentId);
            
            if (appointment) {
                const professional = professionals.find(p => p.id === appointment.professionalId);
                const profName = professional ? professional.name : 'Profissional';
                
                if (confirm(`üóëÔ∏è CONFIRMAR EXCLUS√ÉO\n\nDeseja realmente excluir este agendamento?\n\nProfissional: ${profName}\nCliente: ${appointment.clientName}\nData: ${appointment.date}\nHor√°rio: ${appointment.time}\nTipo: ${getTypeLabel(appointment.type)}\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!`)) {
                    appointments = appointments.filter(a => a.id !== appointmentId);
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    loadScheduleGrid();
                    loadWeeklyScheduleGrid(); // Update weekly view if active
                    closeModal('scheduleModal');
                    showSuccessMessage('üóëÔ∏è Agendamento exclu√≠do com sucesso!');
                }
            }
        }

        function showSuccessMessage(message) {
            // Create temporary success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300';
            notification.style.transform = 'translateX(100%)';
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function showEditOptions(appointment) {
            // Enable all fields for editing
            document.getElementById('appointmentProfessional').disabled = false;
            document.getElementById('clientName').disabled = false;
            document.getElementById('appointmentType').disabled = false;
            document.getElementById('appointmentTimeInput').disabled = false;
            document.getElementById('observations').disabled = false;
            
            // Add visual indicator that this is an editable imported appointment
            const modal = document.getElementById('scheduleModal');
            const existingBadge = modal.querySelector('.import-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // Add badge to show this was imported
            const badge = document.createElement('div');
            badge.className = 'import-badge bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium mb-3 inline-block';
            badge.innerHTML = 'üì• Agendamento Importado - Totalmente Edit√°vel';
            
            const title = modal.querySelector('h3');
            title.parentNode.insertBefore(badge, title.nextSibling);
        }

        function clearScheduleForm() {
            document.getElementById('appointmentProfessional').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('appointmentType').value = '';
            document.getElementById('observations').value = '';
            
            // Remove import badge if exists
            const modal = document.getElementById('scheduleModal');
            const existingBadge = modal.querySelector('.import-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // Enable all fields
            document.getElementById('appointmentProfessional').disabled = false;
            document.getElementById('clientName').disabled = false;
            document.getElementById('appointmentType').disabled = false;
            document.getElementById('appointmentTimeInput').disabled = false;
            document.getElementById('observations').disabled = false;
        }

        // Week Navigation
        function previousWeek() {
            currentWeek.setDate(currentWeek.getDate() - 7);
            loadScheduleGrid();
        }

        function nextWeek() {
            currentWeek.setDate(currentWeek.getDate() + 7);
            loadScheduleGrid();
        }

        // Filter Functions
        function filterByProfessional() {
            selectedProfessional = document.getElementById('professionalFilter').value;
            loadScheduleGrid();
        }

        function searchMainProfessionals() {
            const searchTerm = document.getElementById('mainProfessionalSearch').value.toLowerCase();
            const select = document.getElementById('professionalFilter');
            
            // Clear and rebuild options
            select.innerHTML = '<option value="">Todos os Profissionais</option>';
            
            const filteredProfessionals = professionals.filter(prof => 
                prof.name.toLowerCase().includes(searchTerm)
            );
            
            filteredProfessionals.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof.id;
                option.textContent = prof.name;
                select.appendChild(option);
            });
            
            // If only one result, auto-select it
            if (filteredProfessionals.length === 1) {
                select.value = filteredProfessionals[0].id;
                filterByProfessional();
            }
        }

        function updateProfessionalFilter() {
            const select = document.getElementById('professionalFilter');
            const appointmentSelect = document.getElementById('appointmentProfessional');
            
            // Clear existing options (except first)
            select.innerHTML = '<option value="">Todos os Profissionais</option>';
            appointmentSelect.innerHTML = '<option value="">Selecione o profissional...</option>';
            
            // Only show active professionals in operational filters
            const activeProfessionals = professionals.filter(prof => prof.active !== false);
            
            activeProfessionals.forEach(prof => {
                const option1 = document.createElement('option');
                option1.value = prof.id;
                option1.textContent = prof.name;
                select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = prof.id;
                option2.textContent = prof.name;
                appointmentSelect.appendChild(option2);
            });
        }

        function clearMainProfessionalSelection() {
            selectedProfessional = '';
            document.getElementById('professionalFilter').value = '';
            document.getElementById('mainProfessionalSearch').value = '';
            updateProfessionalFilter();
            loadScheduleGrid();
        }

        function updateAppointmentProfessionals() {
            updateProfessionalFilter();
        }

        function updateWeeklyProfessionalFilter() {
            const select = document.getElementById('weeklyProfessionalFilter');
            
            // Clear existing options (except first)
            select.innerHTML = '<option value="">Todos os Profissionais</option>';
            
            // Only show active professionals in weekly view
            const activeProfessionals = professionals.filter(prof => prof.active !== false);
            
            activeProfessionals.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof.id;
                option.textContent = prof.name;
                select.appendChild(option);
            });
        }

        function filterWeeklyByProfessional() {
            selectedProfessional = document.getElementById('weeklyProfessionalFilter').value;
            updateSelectedProfessionalInfo();
            loadWeeklyScheduleGrid();
        }

        function searchProfessionals() {
            const searchTerm = document.getElementById('professionalSearch').value.toLowerCase();
            const select = document.getElementById('weeklyProfessionalFilter');
            
            // Clear and rebuild options
            select.innerHTML = '<option value="">Todos os Profissionais</option>';
            
            const filteredProfessionals = professionals.filter(prof => 
                prof.name.toLowerCase().includes(searchTerm)
            );
            
            filteredProfessionals.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof.id;
                option.textContent = prof.name;
                select.appendChild(option);
            });
            
            // If only one result, auto-select it
            if (filteredProfessionals.length === 1) {
                select.value = filteredProfessionals[0].id;
                filterWeeklyByProfessional();
            }
        }

        function updateSelectedProfessionalInfo() {
            const infoDiv = document.getElementById('selectedProfessionalInfo');
            const nameSpan = document.getElementById('selectedProfessionalName');
            const specialtySpan = document.getElementById('selectedProfessionalSpecialty');
            
            if (selectedProfessional) {
                const prof = professionals.find(p => p.id === selectedProfessional);
                if (prof) {
                    nameSpan.textContent = prof.name;
                    specialtySpan.textContent = `(${prof.specialty})`;
                    infoDiv.classList.remove('hidden');
                }
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        function clearProfessionalSelection() {
            selectedProfessional = '';
            document.getElementById('weeklyProfessionalFilter').value = '';
            document.getElementById('professionalSearch').value = '';
            document.getElementById('selectedProfessionalInfo').classList.add('hidden');
            updateWeeklyProfessionalFilter();
            loadWeeklyScheduleGrid();
        }

        function loadWeeklyScheduleGrid() {
            const grid = document.getElementById('weeklyScheduleGrid');
            const emptyState = document.getElementById('weeklyEmptyState');
            
            // Check if a professional is selected
            if (!selectedProfessional) {
                grid.style.display = 'none';
                emptyState.classList.remove('hidden');
                return;
            }
            
            // Hide empty state and show grid
            emptyState.classList.add('hidden');
            grid.style.display = 'grid';
            grid.innerHTML = '';
            
            // Create time slots from 7:00 to 19:00 (hourly intervals only)
            const timeSlots = [];
            for (let hour = 7; hour <= 19; hour++) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
            }
            
            // Get week days (Monday to Saturday only - skip Sunday)
            const weekDays = getWeekDays(currentWeek).slice(1, 7); // Skip Sunday (index 0)
            const dayNames = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            
            // Update grid template to 6 columns + 1 for time labels (no Sunday)
            grid.style.gridTemplateColumns = '80px repeat(6, 1fr)';
            
            grid.appendChild(createTimeLabel(''));
            dayNames.forEach(dayName => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = dayName;
                grid.appendChild(header);
            });
            
            // Create time slots
            timeSlots.forEach(time => {
                // Time label
                grid.appendChild(createTimeLabel(time));
                
                // Day slots (6 days - Monday to Saturday)
                for (let dayIndex = 0; dayIndex < 6; dayIndex++) {
                    const slot = createWeeklyTimeSlot(dayIndex + 1, time); // +1 to skip Sunday
                    grid.appendChild(slot);
                }
            });
        }

        function createWeeklyTimeSlot(dayIndex, time) {
            const slot = document.createElement('div');
            slot.className = 'time-slot appointment-slot';
            
            // Get current week days
            const weekDays = getWeekDays(currentWeek);
            const date = weekDays[dayIndex];
            const dateStr = formatDate(date);
            
            const appointment = appointments.find(a => 
                a.date === dateStr && 
                a.time === time && 
                (!selectedProfessional || a.professionalId === selectedProfessional)
            );
            
            if (appointment) {
                slot.className += ' ' + getAppointmentColor(appointment.type);
                if (appointment.type === 'bloqueado') {
                    slot.className += ' blocked-slot';
                }
                slot.innerHTML = `
                    <div class="font-medium truncate" style="font-size: 9px;">${appointment.clientName}</div>
                    <div class="opacity-75 truncate" style="font-size: 8px;">${getTypeLabel(appointment.type)}</div>
                `;
                slot.onclick = () => editAppointment(appointment);
            } else {
                slot.onclick = () => newAppointment(dateStr, time);
            }
            
            return slot;
        }

        function populateTimeSlots() {
            const select = document.getElementById('appointmentTimeInput');
            select.innerHTML = '<option value="">Selecione o hor√°rio...</option>';
            
            for (let hour = 7; hour <= 19; hour++) {
                const time = `${hour.toString().padStart(2, '0')}:00`;
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                select.appendChild(option);
            }
        }

        // Reports
        function generateReports() {
            const container = document.getElementById('reportsContent');
            
            // General Statistics
            const totalAppointments = appointments.length;
            const totalProfessionals = professionals.length;
            
            // Type statistics
            const typeStats = {};
            appointments.forEach(apt => {
                typeStats[apt.type] = (typeStats[apt.type] || 0) + 1;
            });
            
            // Professional statistics
            const profStats = {};
            appointments.forEach(apt => {
                const prof = professionals.find(p => p.id === apt.professionalId);
                if (prof) {
                    profStats[prof.name] = (profStats[prof.name] || 0) + 1;
                }
            });
            
            container.innerHTML = `
                <div class="bg-blue-50 p-6 rounded-lg">
                    <h3 class="font-bold text-blue-800 mb-4 text-lg">üìä Estat√≠sticas Gerais</h3>
                    <div class="space-y-2">
                        <div>Total de Agendamentos: <strong>${totalAppointments}</strong></div>
                        <div>Total de Profissionais: <strong>${totalProfessionals}</strong></div>
                        <div class="mt-4">
                            <div class="font-medium mb-2">Por Tipo de Atendimento:</div>
                            ${Object.entries(typeStats).map(([type, count]) => 
                                `<div class="ml-4">${getTypeLabel(type)}: <strong>${count}</strong></div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
                
                <div class="bg-green-50 p-6 rounded-lg">
                    <h3 class="font-bold text-green-800 mb-4 text-lg">üë• Por Profissional</h3>
                    <div class="space-y-2">
                        ${Object.entries(profStats).map(([name, count]) => 
                            `<div>${name}: <strong>${count}</strong> agendamentos</div>`
                        ).join('') || '<div>Nenhum agendamento encontrado</div>'}
                    </div>
                </div>
            `;
        }

        // Export/Import Functions
        let selectedFile = null;

        function openExportModal() {
            if (!checkPermission('export')) {
                showPermissionDenied('export');
                return;
            }
            document.getElementById('exportModal').classList.add('active');
        }

        function exportScheduleFromModal() {
            if (!checkPermission('export')) {
                showPermissionDenied('export');
                return;
            }
            
            try {
                if (appointments.length === 0) {
                    alert('N√£o h√° agendamentos para exportar!');
                    return;
                }

                const data = appointments.map(apt => {
                    const prof = professionals.find(p => p.id === apt.professionalId);
                    const aptDate = new Date(apt.date + 'T00:00:00');
                    return {
                        'Data': aptDate.toLocaleDateString('pt-BR'),
                        'Hor√°rio': apt.time,
                        'Profissional': prof ? prof.name : 'N/A',
                        'Especialidade': prof ? prof.specialty : 'N/A',
                        'Cliente': apt.clientName,
                        'Tipo': getTypeLabel(apt.type),
                        'Observa√ß√µes': apt.observations || ''
                    };
                });
                
                // Sort by date and time
                data.sort((a, b) => {
                    const dateA = new Date(a.Data.split('/').reverse().join('-') + 'T' + a.Hor√°rio);
                    const dateB = new Date(b.Data.split('/').reverse().join('-') + 'T' + b.Hor√°rio);
                    return dateA - dateB;
                });
                
                const ws = XLSX.utils.json_to_sheet(data);
                
                // Set column widths
                const colWidths = [
                    { wch: 12 }, // Data
                    { wch: 8 },  // Hor√°rio
                    { wch: 20 }, // Profissional
                    { wch: 20 }, // Especialidade
                    { wch: 20 }, // Cliente
                    { wch: 15 }, // Tipo
                    { wch: 30 }  // Observa√ß√µes
                ];
                ws['!cols'] = colWidths;
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Agendamentos');
                
                const fileName = `agendamentos_clinica_aba_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert('Arquivo Excel exportado com sucesso!');
                closeModal('exportModal');
            } catch (error) {
                console.error('Erro ao exportar:', error);
                alert('Erro ao exportar arquivo Excel. Verifique se h√° agendamentos cadastrados.');
            }
        }

        function downloadTemplate() {
            const templateData = [
                {
                    'Data': '01/01/2024',
                    'Hor√°rio': '09:00',
                    'Profissional': 'Nome do Profissional',
                    'Cliente': 'Nome do Cliente',
                    'Tipo': 'Cl√≠nica',
                    'Observa√ß√µes': 'Observa√ß√µes opcionais'
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(templateData);
            
            // Set column widths
            const colWidths = [
                { wch: 12 }, // Data
                { wch: 8 },  // Hor√°rio
                { wch: 20 }, // Profissional
                { wch: 20 }, // Cliente
                { wch: 15 }, // Tipo
                { wch: 30 }  // Observa√ß√µes
            ];
            ws['!cols'] = colWidths;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Modelo');
            
            XLSX.writeFile(wb, 'modelo_agendamentos_clinica_aba.xlsx');
            alert('Modelo de planilha baixado com sucesso!');
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('fileName').textContent = `Arquivo selecionado: ${file.name}`;
                document.getElementById('fileInfo').classList.remove('hidden');
            }
        }

        function clearFileSelection() {
            selectedFile = null;
            document.getElementById('importFile').value = '';
            document.getElementById('fileInfo').classList.add('hidden');
        }

        let importPreviewData = null;

        function importSchedule() {
            if (!checkPermission('import')) {
                showPermissionDenied('import');
                return;
            }
            
            if (!selectedFile) {
                alert('Por favor, selecione um arquivo primeiro!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (!selectedFile.name.endsWith('.xlsx')) {
                        alert('Por favor, selecione apenas arquivos Excel (.xlsx)');
                        return;
                    }

                    // Read Excel workbook
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    
                    const newAppointments = [];
                    const newProfessionals = [];
                    const errors = [];

                    // Process each sheet
                    workbook.SheetNames.forEach(sheetName => {
                        try {
                            const worksheet = workbook.Sheets[sheetName];
                            
                            // Read professional name from B1 only
                            const nameCell = worksheet['B1'];
                            let professionalName = '';
                            
                            if (nameCell && nameCell.v) {
                                professionalName = nameCell.v.toString().trim();
                                
                                // Skip sheets without valid names or with "Horario" or similar
                                if (!professionalName || 
                                    professionalName.toLowerCase().includes('horario') ||
                                    professionalName.toLowerCase().includes('hor√°rio') ||
                                    professionalName.toLowerCase().includes('hora') ||
                                    professionalName.toLowerCase().includes('time') ||
                                    professionalName.toLowerCase() === 'sheet1' ||
                                    professionalName.toLowerCase() === 'planilha1' ||
                                    professionalName.length < 2) {
                                    return; // Skip this sheet
                                }
                            } else {
                                return; // Skip sheets without name in B1
                            }
                            
                            // Read days from C2 to H2
                            const days = [];
                            for (let col = 'C'; col <= 'H'; col = String.fromCharCode(col.charCodeAt(0) + 1)) {
                                const cellRef = col + '2';
                                const cell = worksheet[cellRef];
                                if (cell && cell.v) {
                                    days.push(cell.v.toString().trim());
                                }
                            }

                            // Read times from B3 to B16 (13 time slots: 7:00 to 19:00)
                            const times = [];
                            for (let row = 3; row <= 16; row++) {
                                const cellRef = 'B' + row;
                                const cell = worksheet[cellRef];
                                if (cell && cell.v) {
                                    let timeStr = cell.v.toString().trim();
                                    // Convert '13h' format to '13:00'
                                    if (timeStr.includes('h')) {
                                        timeStr = timeStr.replace('h', ':00');
                                    }
                                    times.push(timeStr);
                                } else {
                                    // If no time in cell, generate based on row (7:00 + row-3)
                                    const hour = 7 + (row - 3);
                                    if (hour <= 19) {
                                        times.push(`${hour.toString().padStart(2, '0')}:00`);
                                    }
                                }
                            }

                            // Process appointments from C3 to H16 (Monday to Saturday only)
                            // C = Segunda, D = Ter√ßa, E = Quarta, F = Quinta, G = Sexta, H = S√°bado
                            const dayColumns = ['C', 'D', 'E', 'F', 'G', 'H']; // Skip Sunday
                            const dayNames = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
                            
                            for (let colIndex = 0; colIndex < dayColumns.length; colIndex++) {
                                const col = dayColumns[colIndex];
                                const dayName = dayNames[colIndex];
                                
                                for (let rowIndex = 0; rowIndex < times.length; rowIndex++) {
                                    const row = rowIndex + 3;
                                    const cellRef = col + row;
                                    const cell = worksheet[cellRef];
                                    
                                    if (cell && cell.v) {
                                        const cellValue = cell.v.toString().trim();
                                        
                                        // Skip empty cells
                                        if (!cellValue) continue;

                                        // Detect appointment type based on cell color and content
                                        let appointmentType = 'clinica'; // default (laranja)
                                        let clientName = cellValue;
                                        
                                        // Check cell background color
                                        if (cell.s && cell.s.fill && cell.s.fill.bgColor) {
                                            const bgColor = cell.s.fill.bgColor;
                                            appointmentType = detectAppointmentTypeByColor(bgColor, cellValue);
                                        } else {
                                            // If no color, try to detect by content
                                            appointmentType = detectAppointmentTypeByContent(cellValue);
                                        }
                                        
                                        // Set appropriate client name for blocked slots
                                        if (appointmentType === 'bloqueado') {
                                            if (cellValue.toLowerCase().includes('almo√ßo') || 
                                                cellValue.toLowerCase().includes('almoco')) {
                                                clientName = 'Almo√ßo';
                                            } else if (cellValue.toLowerCase().includes('deslocamento')) {
                                                clientName = 'Deslocamento';
                                            } else {
                                                clientName = 'Hor√°rio Bloqueado';
                                            }
                                        }

                                        // Find or create professional (use name from B1)
                                        let professional = professionals.find(p => 
                                            p.name.toLowerCase() === professionalName.toLowerCase()
                                        );
                                        
                                        if (!professional) {
                                            // Check if already in newProfessionals
                                            professional = newProfessionals.find(p => 
                                                p.name.toLowerCase() === professionalName.toLowerCase()
                                            );
                                            
                                            if (!professional) {
                                                professional = {
                                                    id: Date.now().toString() + '_' + newProfessionals.length,
                                                    name: professionalName,
                                                    specialty: 'Terapeuta ABA',
                                                    color: getRandomColor()
                                                };
                                                newProfessionals.push(professional);
                                            }
                                        }

                                        // Calculate date based on current week and day
                                        const appointmentDate = calculateDateFromDay(dayName);
                                        
                                        if (appointmentDate) {
                                            const appointment = {
                                                id: Date.now().toString() + '_' + newAppointments.length,
                                                professionalId: professional.id,
                                                date: appointmentDate,
                                                time: times[rowIndex],
                                                clientName: clientName,
                                                type: appointmentType,
                                                observations: ''
                                            };
                                            
                                            newAppointments.push(appointment);
                                        }
                                    }
                                }
                            }
                        } catch (sheetError) {
                            errors.push(`Erro na aba "${sheetName}": ${sheetError.message}`);
                        }
                    });

                    if (errors.length > 0) {
                        alert('Erros encontrados:\n\n' + errors.join('\n'));
                        return;
                    }

                    // Store preview data
                    importPreviewData = {
                        appointments: newAppointments,
                        professionals: newProfessionals
                    };

                    // Show confirmation dialog
                    showImportConfirmation(newProfessionals.length, newAppointments.length);
                    
                } catch (error) {
                    console.error('Erro na importa√ß√£o:', error);
                    alert('Erro ao processar arquivo Excel. Verifique se o formato est√° correto.');
                }
            };

            reader.readAsBinaryString(selectedFile);
        }

        function detectAppointmentTypeByColor(bgColor, cellValue) {
            let colorCode = '';
            
            // First check content for specific keywords and names
            const content = cellValue.toLowerCase();
            if (content.includes('sup') || content.includes('clarissa') || content.includes('reinaldo')) {
                return 'supervisao';
            } else if (content.includes('trein') || content.includes('reun')) {
                return 'treinamento';
            } else if (content.includes('almo√ßo') || content.includes('almoco') || 
                      content.includes('deslocamento') || content.includes('bloqueado')) {
                return 'bloqueado';
            }
            
            // Extract RGB color code
            if (bgColor.rgb) {
                colorCode = bgColor.rgb.toUpperCase();
            } else if (bgColor.indexed) {
                // Handle indexed colors (Excel default palette)
                const indexedColors = {
                    43: 'FFA500', // Orange (Atendimento Cl√≠nica)
                    45: 'FFC0CB', // Pink (An√°lise)
                    41: '0000FF', // Blue (Discuss√£o de Caso)
                    50: '008000', // Green (CLS)
                    36: 'FFFF99', // Light Yellow (Supervis√£o)
                    53: '800080', // Purple (Treinamento)
                    44: 'FFD700', // Gold/Yellow (Orienta√ß√£o Parental)
                    48: 'C0C0C0', // Gray (Bloqueado)
                    15: 'C0C0C0', // Gray (Bloqueado)
                    22: 'C0C0C0'  // Gray (Bloqueado)
                };
                colorCode = indexedColors[bgColor.indexed] || '';
            }
            
            // Detect type by color ranges
            if (isColorInRange(colorCode, ['FFA500', 'FF8C00', 'FF7F00', 'FFA000', 'FF6600'])) {
                return 'clinica'; // Laranja - Atendimento Cl√≠nica
            } else if (isColorInRange(colorCode, ['FFC0CB', 'FFB6C1', 'FF69B4', 'FF1493', 'FFCCCB'])) {
                return 'analise'; // Rosa - An√°lise
            } else if (isColorInRange(colorCode, ['0000FF', '0066FF', '3366FF', '6699FF', '4169E1'])) {
                return 'discussao'; // Azul - Discuss√£o de Caso
            } else if (isColorInRange(colorCode, ['008000', '00FF00', '32CD32', '90EE90', '00CC00'])) {
                return 'cls'; // Verde - CLS
            } else if (isColorInRange(colorCode, ['FFFF99', 'FFFFCC', 'F0F8FF', 'FFFACD', 'FFFFE0'])) {
                return 'supervisao'; // Amarelo claro - Supervis√£o
            } else if (isColorInRange(colorCode, ['800080', '9932CC', 'BA55D3', 'DDA0DD', '8B008B'])) {
                return 'treinamento'; // Roxo - Treinamento
            } else if (isColorInRange(colorCode, ['FFD700', 'FFFF00', 'FFF700', 'FFED4E', 'GOLD'])) {
                return 'orientacao'; // Amarelo gema - Orienta√ß√£o Parental
            } else if (isColorInRange(colorCode, ['C0C0C0', 'CCCCCC', '808080', 'A9A9A9', 'D3D3D3', 'DCDCDC'])) {
                return 'bloqueado'; // Cinza - Bloqueado/Almo√ßo/Deslocamento
            }
            
            // Default to content-based detection if color doesn't match
            return detectAppointmentTypeByContent(cellValue);
        }

        function isColorInRange(colorCode, colorRange) {
            if (!colorCode) return false;
            return colorRange.some(color => {
                // Check if colors are similar (allowing for slight variations)
                const diff = Math.abs(parseInt(colorCode, 16) - parseInt(color, 16));
                return diff < 0x111111; // Allow some tolerance
            });
        }

        function detectAppointmentTypeByContent(cellValue) {
            const content = cellValue.toLowerCase();
            
            // Check for specific keywords and names
            if (content.includes('sup') || content.includes('clarissa') || content.includes('reinaldo')) {
                return 'supervisao';
            } else if (content.includes('trein') || content.includes('reun')) {
                return 'treinamento';
            } else if (content.includes('an√°lise') || content.includes('analise')) {
                return 'analise';
            } else if (content.includes('discuss√£o') || content.includes('discussao') || content.includes('caso')) {
                return 'discussao';
            } else if (content.includes('cls')) {
                return 'cls';
            } else if (content.includes('supervis√£o') || content.includes('supervisao') || content.includes('super')) {
                return 'supervisao';
            } else if (content.includes('treinamento') || content.includes('treino')) {
                return 'treinamento';
            } else if (content.includes('orienta√ß√£o') || content.includes('orientacao') || content.includes('parental')) {
                return 'orientacao';
            } else if (content.includes('almo√ßo') || content.includes('almoco') || 
                      content.includes('deslocamento') || content.includes('bloqueado')) {
                return 'bloqueado';
            }
            
            // Default to clinic appointment
            return 'clinica';
        }

        function getRandomColor() {
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-red-500', 
                          'bg-yellow-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function calculateDateFromDay(dayName) {
            const dayMap = {
                'Segunda': 1, 'Seg': 1, 'Monday': 1,
                'Ter√ßa': 2, 'Ter': 2, 'Tuesday': 2,
                'Quarta': 3, 'Qua': 3, 'Wednesday': 3,
                'Quinta': 4, 'Qui': 4, 'Thursday': 4,
                'Sexta': 5, 'Sex': 5, 'Friday': 5,
                'S√°bado': 6, 'Sab': 6, 'Saturday': 6,
                'Domingo': 0, 'Dom': 0, 'Sunday': 0
            };

            const targetDay = dayMap[dayName];
            if (targetDay === undefined) return null;

            const today = new Date();
            const currentDay = today.getDay();
            const diff = targetDay - currentDay;
            
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + diff);
            
            return formatDate(targetDate);
        }

        function showImportConfirmation(professionalsCount, appointmentsCount) {
            document.getElementById('professionalsCount').innerHTML = 
                `üë®‚Äç‚öïÔ∏è <span class="font-bold">${professionalsCount}</span> profissionais adicionados`;
            document.getElementById('appointmentsCount').innerHTML = 
                `üìÖ <span class="font-bold">${appointmentsCount}</span> agendamentos totais`;
            
            closeModal('exportModal');
            document.getElementById('importConfirmationModal').classList.add('active');
        }

        function confirmImport() {
            if (importPreviewData) {
                // Add new professionals
                importPreviewData.professionals.forEach(prof => {
                    professionals.push(prof);
                });
                
                // Replace appointments
                appointments = importPreviewData.appointments;
                
                // Save to localStorage
                localStorage.setItem('professionals', JSON.stringify(professionals));
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                // Update UI
                updateProfessionalFilter();
                loadScheduleGrid();
                
                // Clear import data
                importPreviewData = null;
                clearFileSelection();
                
                closeModal('importConfirmationModal');
                alert('Dados importados com sucesso!');
            }
        }

        function cancelImport() {
            importPreviewData = null;
            closeModal('importConfirmationModal');
        }

        // Legacy export function for compatibility
        function exportSchedule() {
            openExportModal();
        }

        // Utility Functions
        function getWeekDays(date) {
            const week = [];
            const startOfWeek = new Date(date);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day;
            startOfWeek.setDate(diff);
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                week.push(day);
            }
            
            return week;
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateBR(date) {
            return date.toLocaleDateString('pt-BR');
        }

        function formatDayHeader(date) {
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            return `${days[date.getDay()]}\n${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        }

        function formatSimpleDayHeader(date) {
            const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            return days[date.getDay()];
        }

        // Modal Management
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Bulk Edit Functions
        let filteredBulkAppointments = [];
        let selectedBulkAppointments = [];

        function openBulkEditModal() {
            if (!checkPermission('bulkEdit')) {
                showPermissionDenied('bulkEdit');
                return;
            }
            
            // Populate professional filters
            const bulkFilterProfessional = document.getElementById('bulkFilterProfessional');
            const bulkChangeProfessional = document.getElementById('bulkChangeProfessional');
            const leavingProfessional = document.getElementById('leavingProfessional');
            const replacementProfessional = document.getElementById('replacementProfessional');
            const absentProfessional = document.getElementById('absentProfessional');
            
            bulkFilterProfessional.innerHTML = '<option value="">Todos os Profissionais</option>';
            bulkChangeProfessional.innerHTML = '<option value="">Selecione um profissional...</option>';
            leavingProfessional.innerHTML = '<option value="">Selecione o profissional...</option>';
            replacementProfessional.innerHTML = '<option value="">Selecione o substituto...</option>';
            absentProfessional.innerHTML = '<option value="">Selecione o profissional...</option>';
            
            // Only show active professionals in bulk edit
            const activeProfessionals = professionals.filter(prof => prof.active !== false);
            
            activeProfessionals.forEach(prof => {
                const option1 = document.createElement('option');
                option1.value = prof.id;
                option1.textContent = prof.name;
                bulkFilterProfessional.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = prof.id;
                option2.textContent = prof.name;
                bulkChangeProfessional.appendChild(option2);
                
                const option3 = document.createElement('option');
                option3.value = prof.id;
                option3.textContent = `${prof.name} (${prof.specialty})`;
                leavingProfessional.appendChild(option3);
                
                const option4 = document.createElement('option');
                option4.value = prof.id;
                option4.textContent = `${prof.name} (${prof.specialty})`;
                replacementProfessional.appendChild(option4);
                
                const option5 = document.createElement('option');
                option5.value = prof.id;
                option5.textContent = `${prof.name} (${prof.specialty})`;
                absentProfessional.appendChild(option5);
            });
            
            // Clear filters and load all appointments
            clearBulkFilters();
            filterBulkAppointments();
            
            document.getElementById('bulkEditModal').classList.add('active');
        }

        // Smart Professional Replacement Functions
        let currentReplacementAnalysis = null;
        let conflictResolutions = [];

        function analyzeProfessionalReplacement() {
            const leavingProfId = document.getElementById('leavingProfessional').value;
            if (!leavingProfId) {
                document.getElementById('replacementAnalysis').classList.add('hidden');
                return;
            }

            const leavingProf = professionals.find(p => p.id === leavingProfId);
            // Only consider 'discussao' and 'clinica' appointments for replacement
            const leavingAppointments = appointments.filter(apt => 
                apt.professionalId === leavingProfId && 
                (apt.type === 'discussao' || apt.type === 'clinica')
            );
            
            if (leavingAppointments.length === 0) {
                document.getElementById('analysisResults').innerHTML = `
                    <div class="bg-green-100 p-3 rounded-lg text-green-800">
                        ‚úÖ O profissional <strong>${leavingProf.name}</strong> n√£o possui agendamentos de <strong>Discuss√£o de Caso</strong> ou <strong>Atendimento Cl√≠nica</strong> para substituir.
                        <div class="text-sm mt-2 text-green-700">
                            üí° <strong>Nota:</strong> Apenas agendamentos de Discuss√£o e Cl√≠nica s√£o considerados para substitui√ß√£o inteligente.
                        </div>
                    </div>
                `;
                document.getElementById('replacementAnalysis').classList.remove('hidden');
                return;
            }

            // Analyze appointments by type
            const appointmentsByType = {};
            leavingAppointments.forEach(apt => {
                if (!appointmentsByType[apt.type]) {
                    appointmentsByType[apt.type] = [];
                }
                appointmentsByType[apt.type].push(apt);
            });

            let analysisHtml = `
                <div class="mb-4">
                    <h6 class="font-bold text-gray-800 mb-2">üë®‚Äç‚öïÔ∏è Profissional: ${leavingProf.name} (${leavingProf.specialty})</h6>
                    <div class="text-sm text-gray-600">Total de agendamentos: <strong>${leavingAppointments.length}</strong></div>
                </div>
                <div class="space-y-3">
            `;

            Object.entries(appointmentsByType).forEach(([type, typeAppointments]) => {
                const typeLabel = getTypeLabel(type);
                const typeColor = getAppointmentColor(type);
                
                analysisHtml += `
                    <div class="border rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="px-2 py-1 rounded text-xs ${typeColor}">${typeLabel}</span>
                            <span class="text-sm font-medium">${typeAppointments.length} agendamentos</span>
                        </div>
                        <div class="text-xs text-gray-600 space-y-1">
                `;
                
                typeAppointments.forEach(apt => {
                    const date = new Date(apt.date).toLocaleDateString('pt-BR');
                    analysisHtml += `
                        <div>üìÖ ${date} √†s ${apt.time} - ${apt.clientName}</div>
                    `;
                });
                
                analysisHtml += `</div></div>`;
            });

            analysisHtml += '</div>';
            
            document.getElementById('analysisResults').innerHTML = analysisHtml;
            document.getElementById('replacementAnalysis').classList.remove('hidden');
            
            // Store analysis for later use
            currentReplacementAnalysis = {
                leavingProfId: leavingProfId,
                leavingProf: leavingProf,
                appointments: leavingAppointments,
                appointmentsByType: appointmentsByType
            };
        }

        function checkReplacementCompatibility() {
            const replacementProfId = document.getElementById('replacementProfessional').value;
            if (!replacementProfId || !currentReplacementAnalysis) return;

            const replacementProf = professionals.find(p => p.id === replacementProfId);
            const replacementAppointments = appointments.filter(apt => apt.professionalId === replacementProfId);
            
            // Check for time conflicts
            const conflicts = [];
            const compatibleReplacements = [];
            const problematicTypes = [];

            currentReplacementAnalysis.appointments.forEach(leavingApt => {
                const conflict = replacementAppointments.find(replApt => 
                    replApt.date === leavingApt.date && replApt.time === leavingApt.time
                );
                
                if (conflict) {
                    conflicts.push({
                        leaving: leavingApt,
                        replacement: conflict,
                        date: leavingApt.date,
                        time: leavingApt.time
                    });
                } else {
                    // Check if replacement professional can handle this type of appointment
                    const canHandle = checkProfessionalCompatibility(replacementProf, leavingApt.type);
                    if (canHandle) {
                        compatibleReplacements.push(leavingApt);
                    } else {
                        problematicTypes.push(leavingApt);
                    }
                }
            });

            // Update analysis with compatibility results
            let compatibilityHtml = `
                <div class="mt-4 border-t pt-4">
                    <h6 class="font-bold text-gray-800 mb-3">üîÑ An√°lise de Compatibilidade com ${replacementProf.name}</h6>
            `;

            if (compatibleReplacements.length > 0) {
                compatibilityHtml += `
                    <div class="mb-3 bg-green-50 p-3 rounded-lg">
                        <div class="font-medium text-green-800 mb-2">‚úÖ Substitui√ß√µes Diretas Poss√≠veis (${compatibleReplacements.length})</div>
                        <div class="text-xs text-green-700 space-y-1">
                `;
                compatibleReplacements.forEach(apt => {
                    const date = new Date(apt.date).toLocaleDateString('pt-BR');
                    compatibilityHtml += `<div>üìÖ ${date} √†s ${apt.time} - ${apt.clientName} (${getTypeLabel(apt.type)})</div>`;
                });
                compatibilityHtml += '</div></div>';
            }

            if (conflicts.length > 0) {
                compatibilityHtml += `
                    <div class="mb-3 bg-red-50 p-3 rounded-lg">
                        <div class="font-medium text-red-800 mb-2">‚ö†Ô∏è Conflitos de Hor√°rio (${conflicts.length})</div>
                        <div class="text-xs text-red-700 space-y-1">
                `;
                conflicts.forEach(conflict => {
                    const date = new Date(conflict.date).toLocaleDateString('pt-BR');
                    compatibilityHtml += `
                        <div class="border-l-2 border-red-300 pl-2">
                            üìÖ ${date} √†s ${conflict.time}:<br>
                            ‚Ä¢ Saindo: ${conflict.leaving.clientName} (${getTypeLabel(conflict.leaving.type)})<br>
                            ‚Ä¢ Conflito: ${conflict.replacement.clientName} (${getTypeLabel(conflict.replacement.type)})
                        </div>
                    `;
                });
                compatibilityHtml += '</div></div>';
            }

            if (problematicTypes.length > 0) {
                compatibilityHtml += `
                    <div class="mb-3 bg-yellow-50 p-3 rounded-lg">
                        <div class="font-medium text-yellow-800 mb-2">‚ö†Ô∏è Incompatibilidade de Especialidade (${problematicTypes.length})</div>
                        <div class="text-xs text-yellow-700 space-y-1">
                `;
                problematicTypes.forEach(apt => {
                    const date = new Date(apt.date).toLocaleDateString('pt-BR');
                    compatibilityHtml += `<div>üìÖ ${date} √†s ${apt.time} - ${apt.clientName} (${getTypeLabel(apt.type)})</div>`;
                });
                compatibilityHtml += '</div></div>';
            }

            compatibilityHtml += '</div>';
            
            document.getElementById('analysisResults').innerHTML += compatibilityHtml;
            
            // Store conflict data for resolution
            currentReplacementAnalysis.conflicts = conflicts;
            currentReplacementAnalysis.compatibleReplacements = compatibleReplacements;
            currentReplacementAnalysis.problematicTypes = problematicTypes;
            currentReplacementAnalysis.replacementProf = replacementProf;
        }

        function checkProfessionalCompatibility(professional, appointmentType) {
            // For smart replacement, only consider 'discussao' and 'clinica' types
            if (appointmentType !== 'discussao' && appointmentType !== 'clinica') {
                return false;
            }
            
            // Define compatibility rules based on specialty and appointment type
            const compatibilityRules = {
                'PSICO ABA': ['clinica', 'discussao'],
                'PSICO COMUM': ['clinica', 'discussao'],
                'ATAC': ['clinica'],
                'ATM': ['clinica'],
                'ATs': ['clinica'],
                'FONO': ['clinica', 'discussao'],
                'T.O': ['clinica', 'discussao'],
                'NEUROPSI': ['clinica', 'discussao'],
                'MUSICOTERAPIA': ['clinica'],
                'PSICOMOTRICIDADE': ['clinica']
            };

            const allowedTypes = compatibilityRules[professional.specialty] || ['clinica'];
            return allowedTypes.includes(appointmentType);
        }

        function executeSmartReplacement() {
            if (!currentReplacementAnalysis || !currentReplacementAnalysis.replacementProf) {
                alert('‚ö†Ô∏è Selecione primeiro o profissional substituto!');
                return;
            }

            const { conflicts, compatibleReplacements, problematicTypes } = currentReplacementAnalysis;
            
            if (conflicts.length > 0 || problematicTypes.length > 0) {
                alert(`‚ö†Ô∏è Existem ${conflicts.length} conflitos de hor√°rio e ${problematicTypes.length} incompatibilidades de especialidade que precisam ser resolvidos primeiro.\n\nClique em "Resolver Conflitos" para ver as op√ß√µes.`);
                return;
            }

            if (compatibleReplacements.length === 0) {
                alert('‚ö†Ô∏è N√£o h√° agendamentos compat√≠veis para substitui√ß√£o direta!');
                return;
            }

            const confirmMessage = `üîÑ CONFIRMAR SUBSTITUI√á√ÉO INTELIGENTE\n\n` +
                `Profissional saindo: ${currentReplacementAnalysis.leavingProf.name}\n` +
                `Novo profissional: ${currentReplacementAnalysis.replacementProf.name}\n\n` +
                `Ser√£o substitu√≠dos ${compatibleReplacements.length} agendamentos compat√≠veis.\n\n` +
                `‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!\n\nDeseja continuar?`;

            if (confirm(confirmMessage)) {
                let replacedCount = 0;
                
                compatibleReplacements.forEach(apt => {
                    const index = appointments.findIndex(a => a.id === apt.id);
                    if (index !== -1) {
                        appointments[index].professionalId = currentReplacementAnalysis.replacementProf.id;
                        replacedCount++;
                    }
                });

                localStorage.setItem('appointments', JSON.stringify(appointments));
                loadScheduleGrid();
                loadWeeklyScheduleGrid();
                
                // Clear analysis
                currentReplacementAnalysis = null;
                document.getElementById('leavingProfessional').value = '';
                document.getElementById('replacementProfessional').value = '';
                document.getElementById('replacementAnalysis').classList.add('hidden');
                
                showSuccessMessage(`‚úÖ Substitui√ß√£o conclu√≠da! ${replacedCount} agendamentos foram transferidos com sucesso.`);
            }
        }

        function showConflictResolution() {
            if (!currentReplacementAnalysis || !currentReplacementAnalysis.conflicts) {
                alert('‚ö†Ô∏è Nenhum conflito detectado para resolver!');
                return;
            }

            const { conflicts, problematicTypes, replacementProf } = currentReplacementAnalysis;
            
            // Generate conflict resolution suggestions
            conflictResolutions = [];
            let conflictsHtml = '';
            let suggestionsHtml = '';

            // Handle time conflicts
            conflicts.forEach((conflict, index) => {
                const date = new Date(conflict.date).toLocaleDateString('pt-BR');
                conflictsHtml += `
                    <div class="bg-white p-3 rounded-lg border border-red-200">
                        <div class="font-medium text-red-800 mb-2">‚ö†Ô∏è Conflito ${index + 1}: ${date} √†s ${conflict.time}</div>
                        <div class="text-sm space-y-1">
                            <div class="text-red-700">üîÑ Saindo: ${conflict.leaving.clientName} (${getTypeLabel(conflict.leaving.type)})</div>
                            <div class="text-red-700">‚ùå Conflito: ${conflict.replacement.clientName} (${getTypeLabel(conflict.replacement.type)})</div>
                        </div>
                    </div>
                `;

                // Find alternative time slots
                const alternatives = findAlternativeTimeSlots(conflict.leaving, replacementProf.id);
                if (alternatives.length > 0) {
                    suggestionsHtml += `
                        <div class="bg-white p-3 rounded-lg border border-blue-200 mb-3">
                            <div class="font-medium text-blue-800 mb-2">üí° Sugest√µes para: ${conflict.leaving.clientName}</div>
                            <div class="space-y-2">
                    `;
                    
                    alternatives.slice(0, 3).forEach((alt, altIndex) => {
                        const altDate = new Date(alt.date).toLocaleDateString('pt-BR');
                        const resolutionId = `conflict_${index}_alt_${altIndex}`;
                        
                        suggestionsHtml += `
                            <label class="flex items-center space-x-2 text-sm">
                                <input type="radio" name="conflict_${index}" value="${resolutionId}" 
                                       onchange="selectResolution('${resolutionId}', ${JSON.stringify(conflict).replace(/"/g, '&quot;')}, ${JSON.stringify(alt).replace(/"/g, '&quot;')})">
                                <span>üìÖ ${altDate} √†s ${alt.time}</span>
                            </label>
                        `;
                        
                        conflictResolutions.push({
                            id: resolutionId,
                            type: 'reschedule',
                            original: conflict.leaving,
                            newSlot: alt
                        });
                    });
                    
                    // Option to cancel the appointment
                    const cancelId = `conflict_${index}_cancel`;
                    suggestionsHtml += `
                        <label class="flex items-center space-x-2 text-sm text-red-600">
                            <input type="radio" name="conflict_${index}" value="${cancelId}" 
                                   onchange="selectResolution('${cancelId}', ${JSON.stringify(conflict).replace(/"/g, '&quot;')}, null)">
                            <span>üóëÔ∏è Cancelar este agendamento</span>
                        </label>
                    `;
                    
                    conflictResolutions.push({
                        id: cancelId,
                        type: 'cancel',
                        original: conflict.leaving
                    });
                    
                    suggestionsHtml += '</div></div>';
                } else {
                    suggestionsHtml += `
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 mb-3">
                            <div class="font-medium text-yellow-800 mb-2">‚ö†Ô∏è ${conflict.leaving.clientName}</div>
                            <div class="text-sm text-yellow-700">N√£o foram encontrados hor√°rios alternativos dispon√≠veis.</div>
                            <label class="flex items-center space-x-2 text-sm text-red-600 mt-2">
                                <input type="radio" name="conflict_${index}" value="conflict_${index}_cancel" 
                                       onchange="selectResolution('conflict_${index}_cancel', ${JSON.stringify(conflict).replace(/"/g, '&quot;')}, null)">
                                <span>üóëÔ∏è Cancelar este agendamento</span>
                            </label>
                        </div>
                    `;
                }
            });

            // Handle problematic types
            problematicTypes.forEach((apt, index) => {
                const date = new Date(apt.date).toLocaleDateString('pt-BR');
                conflictsHtml += `
                    <div class="bg-white p-3 rounded-lg border border-yellow-200">
                        <div class="font-medium text-yellow-800 mb-2">‚ö†Ô∏è Incompatibilidade: ${date} √†s ${apt.time}</div>
                        <div class="text-sm text-yellow-700">
                            ${apt.clientName} (${getTypeLabel(apt.type)}) - ${replacementProf.name} n√£o pode realizar este tipo de atendimento
                        </div>
                    </div>
                `;

                // Find compatible professionals for this type
                const compatibleProfs = findCompatibleProfessionals(apt.type, apt.date, apt.time);
                if (compatibleProfs.length > 0) {
                    suggestionsHtml += `
                        <div class="bg-white p-3 rounded-lg border border-green-200 mb-3">
                            <div class="font-medium text-green-800 mb-2">üí° Profissionais compat√≠veis para: ${apt.clientName}</div>
                            <div class="space-y-2">
                    `;
                    
                    compatibleProfs.forEach((prof, profIndex) => {
                        const resolutionId = `incompatible_${index}_prof_${profIndex}`;
                        
                        suggestionsHtml += `
                            <label class="flex items-center space-x-2 text-sm">
                                <input type="radio" name="incompatible_${index}" value="${resolutionId}" 
                                       onchange="selectResolution('${resolutionId}', ${JSON.stringify(apt).replace(/"/g, '&quot;')}, ${JSON.stringify(prof).replace(/"/g, '&quot;')})">
                                <span>üë®‚Äç‚öïÔ∏è ${prof.name} (${prof.specialty})</span>
                            </label>
                        `;
                        
                        conflictResolutions.push({
                            id: resolutionId,
                            type: 'reassign',
                            original: apt,
                            newProfessional: prof
                        });
                    });
                    
                    suggestionsHtml += '</div></div>';
                }
            });

            document.getElementById('conflictsList').innerHTML = conflictsHtml;
            document.getElementById('resolutionSuggestions').innerHTML = suggestionsHtml;
            document.getElementById('conflictResolutionModal').classList.add('active');
        }

        function findAlternativeTimeSlots(appointment, professionalId) {
            const alternatives = [];
            const currentDate = new Date(appointment.date);
            
            // Check same day, different times
            const timeSlots = [];
            for (let hour = 7; hour <= 19; hour++) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
            }
            
            timeSlots.forEach(time => {
                if (time !== appointment.time) {
                    const conflict = appointments.find(apt => 
                        apt.date === appointment.date && 
                        apt.time === time && 
                        apt.professionalId === professionalId
                    );
                    
                    if (!conflict) {
                        alternatives.push({
                            date: appointment.date,
                            time: time
                        });
                    }
                }
            });
            
            // Check next 7 days, same time
            for (let dayOffset = 1; dayOffset <= 7; dayOffset++) {
                const checkDate = new Date(currentDate);
                checkDate.setDate(currentDate.getDate() + dayOffset);
                
                // Skip Sundays
                if (checkDate.getDay() === 0) continue;
                
                const checkDateStr = formatDate(checkDate);
                const conflict = appointments.find(apt => 
                    apt.date === checkDateStr && 
                    apt.time === appointment.time && 
                    apt.professionalId === professionalId
                );
                
                if (!conflict) {
                    alternatives.push({
                        date: checkDateStr,
                        time: appointment.time
                    });
                }
            }
            
            return alternatives;
        }

        function findCompatibleProfessionals(appointmentType, date, time) {
            const compatibleProfs = [];
            
            professionals.forEach(prof => {
                if (checkProfessionalCompatibility(prof, appointmentType)) {
                    // Check if professional is available at this time
                    const conflict = appointments.find(apt => 
                        apt.date === date && 
                        apt.time === time && 
                        apt.professionalId === prof.id
                    );
                    
                    if (!conflict) {
                        compatibleProfs.push(prof);
                    }
                }
            });
            
            return compatibleProfs;
        }

        let selectedResolutions = {};

        function selectResolution(resolutionId, original, newOption) {
            selectedResolutions[resolutionId] = {
                resolution: conflictResolutions.find(r => r.id === resolutionId),
                original: original,
                newOption: newOption
            };
        }

        function applyConflictResolutions() {
            const resolutionCount = Object.keys(selectedResolutions).length;
            const totalConflicts = (currentReplacementAnalysis.conflicts?.length || 0) + 
                                 (currentReplacementAnalysis.problematicTypes?.length || 0);
            
            if (resolutionCount < totalConflicts) {
                alert(`‚ö†Ô∏è Selecione uma resolu√ß√£o para todos os ${totalConflicts} conflitos antes de continuar!`);
                return;
            }

            if (confirm(`üîÑ APLICAR RESOLU√á√ïES\n\nSer√£o aplicadas ${resolutionCount} resolu√ß√µes de conflitos.\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!\n\nDeseja continuar?`)) {
                let appliedCount = 0;
                
                Object.values(selectedResolutions).forEach(({ resolution }) => {
                    const aptIndex = appointments.findIndex(a => a.id === resolution.original.id);
                    
                    if (aptIndex !== -1) {
                        switch (resolution.type) {
                            case 'reschedule':
                                appointments[aptIndex].date = resolution.newSlot.date;
                                appointments[aptIndex].time = resolution.newSlot.time;
                                appointments[aptIndex].professionalId = currentReplacementAnalysis.replacementProf.id;
                                appliedCount++;
                                break;
                                
                            case 'cancel':
                                appointments.splice(aptIndex, 1);
                                appliedCount++;
                                break;
                                
                            case 'reassign':
                                appointments[aptIndex].professionalId = resolution.newProfessional.id;
                                appliedCount++;
                                break;
                        }
                    }
                });

                localStorage.setItem('appointments', JSON.stringify(appointments));
                loadScheduleGrid();
                loadWeeklyScheduleGrid();
                
                closeModal('conflictResolutionModal');
                
                // Clear analysis and selections
                selectedResolutions = {};
                currentReplacementAnalysis = null;
                document.getElementById('leavingProfessional').value = '';
                document.getElementById('replacementProfessional').value = '';
                document.getElementById('replacementAnalysis').classList.add('hidden');
                
                showSuccessMessage(`‚úÖ Resolu√ß√µes aplicadas! ${appliedCount} conflitos foram resolvidos com sucesso.`);
            }
        }

        function filterBulkAppointments() {
            const professionalFilter = document.getElementById('bulkFilterProfessional').value;
            const typeFilter = document.getElementById('bulkFilterType').value;
            const clientFilter = document.getElementById('bulkFilterClient').value.toLowerCase();
            
            filteredBulkAppointments = appointments.filter(apt => {
                const professional = professionals.find(p => p.id === apt.professionalId);
                const profMatch = !professionalFilter || apt.professionalId === professionalFilter;
                const typeMatch = !typeFilter || apt.type === typeFilter;
                const clientMatch = !clientFilter || apt.clientName.toLowerCase().includes(clientFilter);
                
                return profMatch && typeMatch && clientMatch;
            });
            
            // Sort by date and time
            filteredBulkAppointments.sort((a, b) => {
                const dateA = new Date(a.date + 'T' + a.time);
                const dateB = new Date(b.date + 'T' + b.time);
                return dateA - dateB;
            });
            
            displayBulkAppointments();
        }

        function displayBulkAppointments() {
            const container = document.getElementById('bulkAppointmentsList');
            const countSpan = document.getElementById('bulkResultsCount');
            
            countSpan.textContent = `${filteredBulkAppointments.length} agendamentos`;
            
            if (filteredBulkAppointments.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-500">Nenhum agendamento encontrado com os filtros aplicados</div>';
                return;
            }
            
            container.innerHTML = filteredBulkAppointments.map(apt => {
                const professional = professionals.find(p => p.id === apt.professionalId);
                const profName = professional ? professional.name : 'N/A';
                const isSelected = selectedBulkAppointments.includes(apt.id);
                
                return `
                    <div class="flex items-center p-3 border-b hover:bg-gray-50 ${isSelected ? 'bg-blue-50' : ''}">
                        <input type="checkbox" 
                               id="bulk_${apt.id}" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="toggleBulkSelection('${apt.id}')"
                               class="mr-3">
                        <div class="flex-1 grid grid-cols-1 md:grid-cols-6 gap-2 text-sm">
                            <div><strong>Data:</strong> ${new Date(apt.date).toLocaleDateString('pt-BR')}</div>
                            <div><strong>Hor√°rio:</strong> ${apt.time}</div>
                            <div><strong>Profissional:</strong> ${profName}</div>
                            <div><strong>Cliente:</strong> ${apt.clientName}</div>
                            <div><strong>Tipo:</strong> <span class="px-2 py-1 rounded text-xs ${getAppointmentColor(apt.type)}">${getTypeLabel(apt.type)}</span></div>
                            <div class="flex gap-1">
                                <button onclick="editAppointment(${JSON.stringify(apt).replace(/"/g, '&quot;')})" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs">
                                    ‚úèÔ∏è Editar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleBulkSelection(appointmentId) {
            const index = selectedBulkAppointments.indexOf(appointmentId);
            if (index > -1) {
                selectedBulkAppointments.splice(index, 1);
            } else {
                selectedBulkAppointments.push(appointmentId);
            }
            displayBulkAppointments();
        }

        function selectAllFiltered() {
            selectedBulkAppointments = [...new Set([...selectedBulkAppointments, ...filteredBulkAppointments.map(apt => apt.id)])];
            displayBulkAppointments();
        }

        function deselectAll() {
            selectedBulkAppointments = [];
            displayBulkAppointments();
        }

        function clearBulkFilters() {
            document.getElementById('bulkFilterProfessional').value = '';
            document.getElementById('bulkFilterType').value = '';
            document.getElementById('bulkFilterClient').value = '';
            selectedBulkAppointments = [];
        }

        function applyBulkChanges() {
            if (selectedBulkAppointments.length === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos um agendamento para aplicar as altera√ß√µes!');
                return;
            }
            
            const newType = document.getElementById('bulkChangeType').value;
            const newProfessionalId = document.getElementById('bulkChangeProfessional').value;
            
            if (!newType && !newProfessionalId) {
                alert('‚ö†Ô∏è Selecione pelo menos uma altera√ß√£o para aplicar (Tipo ou Profissional)!');
                return;
            }
            
            let changeDescription = [];
            if (newType) changeDescription.push(`Tipo: ${getTypeLabel(newType)}`);
            if (newProfessionalId) {
                const prof = professionals.find(p => p.id === newProfessionalId);
                changeDescription.push(`Profissional: ${prof ? prof.name : 'N/A'}`);
            }
            
            if (confirm(`üîÑ CONFIRMAR ALTERA√á√ïES EM LOTE\n\nSer√£o alterados ${selectedBulkAppointments.length} agendamentos:\n\n${changeDescription.join('\n')}\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!\n\nDeseja continuar?`)) {
                let updatedCount = 0;
                
                selectedBulkAppointments.forEach(appointmentId => {
                    const index = appointments.findIndex(a => a.id === appointmentId);
                    if (index !== -1) {
                        if (newType) appointments[index].type = newType;
                        if (newProfessionalId) appointments[index].professionalId = newProfessionalId;
                        updatedCount++;
                    }
                });
                
                localStorage.setItem('appointments', JSON.stringify(appointments));
                loadScheduleGrid();
                loadWeeklyScheduleGrid();
                
                // Clear selections and refresh
                selectedBulkAppointments = [];
                document.getElementById('bulkChangeType').value = '';
                document.getElementById('bulkChangeProfessional').value = '';
                filterBulkAppointments();
                
                showSuccessMessage(`‚úÖ ${updatedCount} agendamentos atualizados com sucesso!`);
            }
        }

        function deleteBulkSelected() {
            if (selectedBulkAppointments.length === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos um agendamento para excluir!');
                return;
            }
            
            if (confirm(`üóëÔ∏è CONFIRMAR EXCLUS√ÉO EM LOTE\n\nSer√£o exclu√≠dos ${selectedBulkAppointments.length} agendamentos selecionados.\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!\n\nDeseja continuar?`)) {
                appointments = appointments.filter(apt => !selectedBulkAppointments.includes(apt.id));
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                loadScheduleGrid();
                loadWeeklyScheduleGrid();
                
                // Clear selections and refresh
                const deletedCount = selectedBulkAppointments.length;
                selectedBulkAppointments = [];
                filterBulkAppointments();
                
                showSuccessMessage(`üóëÔ∏è ${deletedCount} agendamentos exclu√≠dos com sucesso!`);
            }
        }

        // Absence Replacement Functions
        let currentAbsenceAnalysis = null;
        let selectedAbsenceReplacements = [];

        function analyzeAbsenceReplacement() {
            const absentProfId = document.getElementById('absentProfessional').value;
            const absenceDay = document.getElementById('absenceDay').value;
            
            if (!absentProfId || !absenceDay) {
                document.getElementById('absenceAnalysis').classList.add('hidden');
                return;
            }

            const absentProf = professionals.find(p => p.id === absentProfId);
            const dayNames = ['', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'];
            const selectedDayName = dayNames[parseInt(absenceDay)];
            
            // Find appointments for this professional on this day of the week
            const absentAppointments = appointments.filter(apt => {
                if (apt.professionalId !== absentProfId) return false;
                
                const aptDate = new Date(apt.date);
                const aptDayOfWeek = aptDate.getDay();
                
                // Convert Sunday (0) to 7 for easier comparison
                const normalizedDay = aptDayOfWeek === 0 ? 7 : aptDayOfWeek;
                
                return normalizedDay === parseInt(absenceDay);
            });
            
            if (absentAppointments.length === 0) {
                document.getElementById('absenceResults').innerHTML = `
                    <div class="bg-green-100 p-3 rounded-lg text-green-800">
                        ‚úÖ O profissional <strong>${absentProf.name}</strong> n√£o possui agendamentos √†s <strong>${selectedDayName}</strong>.
                    </div>
                `;
                document.getElementById('absenceAnalysis').classList.remove('hidden');
                return;
            }

            // Analyze each appointment and find replacements by priority
            const replacementOptions = [];
            
            absentAppointments.forEach(apt => {
                const options = findReplacementsByPriority(apt, absenceDay);
                replacementOptions.push({
                    appointment: apt,
                    options: options
                });
            });

            // Display analysis results
            let analysisHtml = `
                <div class="mb-4">
                    <h6 class="font-bold text-gray-800 mb-2">üë®‚Äç‚öïÔ∏è Profissional Ausente: ${absentProf.name} (${absentProf.specialty})</h6>
                    <div class="text-sm text-gray-600">Dia da semana: <strong>${selectedDayName}</strong></div>
                    <div class="text-sm text-gray-600">Agendamentos afetados: <strong>${absentAppointments.length}</strong></div>
                </div>
                <div class="space-y-4">
            `;

            replacementOptions.forEach((item, index) => {
                const apt = item.appointment;
                const options = item.options;
                
                analysisHtml += `
                    <div class="border rounded-lg p-3 ${options.length > 0 ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                        <div class="flex items-center justify-between mb-3">
                            <div class="cursor-pointer hover:bg-blue-100 p-2 rounded transition-colors" onclick="showTimeSlotOptions(${index})">
                                <span class="font-medium text-blue-600 underline">${apt.time} - ${apt.clientName}</span>
                                <span class="ml-2 px-2 py-1 rounded text-xs ${getAppointmentColor(apt.type)}">${getTypeLabel(apt.type)}</span>
                                <span class="ml-2 text-xs text-blue-500">üëÜ Clique para ver op√ß√µes</span>
                            </div>
                            <div class="text-sm ${options.length > 0 ? 'text-green-600' : 'text-red-600'}">
                                ${options.length > 0 ? `${options.length} op√ß√µes encontradas` : 'Nenhuma op√ß√£o dispon√≠vel'}
                            </div>
                        </div>
                `;

                if (options.length > 0) {
                    analysisHtml += `<div class="space-y-2">`;
                    
                    // Show top 3 options by priority
                    options.slice(0, 3).forEach((option, optIndex) => {
                        const priorityIcon = getPriorityIcon(option.priority);
                        const priorityLabel = getPriorityLabel(option.priority);
                        
                        analysisHtml += `
                            <div class="flex items-center justify-between bg-white p-2 rounded border">
                                <div class="flex items-center space-x-2">
                                    <span class="text-lg">${priorityIcon}</span>
                                    <span class="font-medium">${option.professional.name}</span>
                                    <span class="text-sm text-gray-600">(${option.professional.specialty})</span>
                                </div>
                                <div class="text-xs">
                                    <span class="px-2 py-1 rounded ${getPriorityColor(option.priority)}">${priorityLabel}</span>
                                    ${option.currentActivity ? `<span class="ml-1 text-gray-500">‚Ä¢ ${getTypeLabel(option.currentActivity)}</span>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    if (options.length > 3) {
                        analysisHtml += `<div class="text-xs text-gray-500 text-center cursor-pointer hover:text-blue-600" onclick="showTimeSlotOptions(${index})">+ ${options.length - 3} outras op√ß√µes dispon√≠veis - Clique para ver todas</div>`;
                    }
                    
                    analysisHtml += `</div>`;
                } else {
                    analysisHtml += `
                        <div class="text-sm text-red-600 bg-white p-2 rounded border border-red-200">
                            ‚ö†Ô∏è Nenhum profissional dispon√≠vel ou compat√≠vel encontrado para este hor√°rio
                        </div>
                    `;
                }
                
                analysisHtml += `</div>`;
            });

            analysisHtml += '</div>';
            
            document.getElementById('absenceResults').innerHTML = analysisHtml;
            document.getElementById('absenceAnalysis').classList.remove('hidden');
            
            // Store analysis for later use
            currentAbsenceAnalysis = {
                absentProfId: absentProfId,
                absentProf: absentProf,
                absenceDay: absenceDay,
                selectedDayName: selectedDayName,
                appointments: absentAppointments,
                replacementOptions: replacementOptions
            };
        }

        function findReplacementsByPriority(appointment, dayOfWeek) {
            const options = [];
            
            // Get all professionals except the absent one
            const availableProfessionals = professionals.filter(p => p.id !== appointment.professionalId);
            
            availableProfessionals.forEach(prof => {
                // Check if professional is compatible with appointment type
                if (!checkProfessionalCompatibility(prof, appointment.type)) {
                    return; // Skip incompatible professionals
                }
                
                // Find appointments for this professional on the same day of week and time
                const currentAppointments = appointments.filter(apt => {
                    if (apt.professionalId !== prof.id || apt.time !== appointment.time) return false;
                    
                    const aptDate = new Date(apt.date);
                    const aptDayOfWeek = aptDate.getDay();
                    
                    // Convert Sunday (0) to 7 for easier comparison
                    const normalizedDay = aptDayOfWeek === 0 ? 7 : aptDayOfWeek;
                    
                    return normalizedDay === parseInt(dayOfWeek);
                });
                
                let priority = 5; // Default: completely free
                let currentActivity = null;
                let currentAppointment = null;
                
                if (currentAppointments.length > 0) {
                    // Use the first appointment found (they should all be the same time/day pattern)
                    currentAppointment = currentAppointments[0];
                    currentActivity = currentAppointment.type;
                    
                    // Set priority based on current activity (lower number = higher priority)
                    switch (currentAppointment.type) {
                        case 'cls':
                            priority = 1; // Highest priority
                            break;
                        case 'analise':
                            priority = 2;
                            break;
                        case 'supervisao':
                            priority = 3;
                            break;
                        case 'discussao':
                            priority = 4;
                            break;
                        case 'bloqueado':
                            return; // Skip blocked slots
                        default:
                            return; // Skip other types (clinica, etc.) as they can't be easily moved
                    }
                }
                
                options.push({
                    professional: prof,
                    priority: priority,
                    currentActivity: currentActivity,
                    currentAppointment: currentAppointment,
                    affectedAppointments: currentAppointments // All appointments that would be affected
                });
            });
            
            // Sort by priority (lower number = higher priority)
            options.sort((a, b) => a.priority - b.priority);
            
            return options;
        }

        function getPriorityIcon(priority) {
            const icons = {
                1: 'ü•á', // CLS
                2: 'ü•à', // An√°lise
                3: 'ü•â', // Supervis√£o
                4: 'üèÖ', // Discuss√£o
                5: 'üìã'  // Livre
            };
            return icons[priority] || 'üìã';
        }

        function getPriorityLabel(priority) {
            const labels = {
                1: '1¬™ Prioridade (CLS)',
                2: '2¬™ Prioridade (An√°lise)',
                3: '3¬™ Prioridade (Supervis√£o)',
                4: '4¬™ Prioridade (Discuss√£o)',
                5: 'Hor√°rio Livre'
            };
            return labels[priority] || 'Hor√°rio Livre';
        }

        function getPriorityColor(priority) {
            const colors = {
                1: 'bg-green-100 text-green-800',
                2: 'bg-blue-100 text-blue-800',
                3: 'bg-yellow-100 text-yellow-800',
                4: 'bg-orange-100 text-orange-800',
                5: 'bg-gray-100 text-gray-800'
            };
            return colors[priority] || 'bg-gray-100 text-gray-800';
        }

        function executeAbsenceReplacement() {
            if (!currentAbsenceAnalysis) {
                alert('‚ö†Ô∏è Nenhuma an√°lise de falta dispon√≠vel!');
                return;
            }

            // Auto-select best options (priority 1-3 only)
            const autoReplacements = [];
            
            currentAbsenceAnalysis.replacementOptions.forEach(item => {
                const bestOption = item.options.find(opt => opt.priority <= 3);
                if (bestOption) {
                    autoReplacements.push({
                        appointment: item.appointment,
                        replacement: bestOption
                    });
                }
            });

            if (autoReplacements.length === 0) {
                alert('‚ö†Ô∏è N√£o h√° substitui√ß√µes autom√°ticas dispon√≠veis. Use "Ver Todas as Op√ß√µes" para escolher manualmente.');
                return;
            }

            const confirmMessage = `üö® SUBSTITUI√á√ÉO DE EMERG√äNCIA\n\n` +
                `Profissional ausente: ${currentAbsenceAnalysis.absentProf.name}\n` +
                `Data: ${new Date(currentAbsenceAnalysis.absenceDate).toLocaleDateString('pt-BR')}\n\n` +
                `Ser√£o aplicadas ${autoReplacements.length} substitui√ß√µes autom√°ticas (apenas prioridades altas).\n\n` +
                `‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!\n\nDeseja continuar?`;

            if (confirm(confirmMessage)) {
                let replacedCount = 0;
                
                autoReplacements.forEach(replacement => {
                    // Update the absent professional's appointment
                    const aptIndex = appointments.findIndex(a => a.id === replacement.appointment.id);
                    if (aptIndex !== -1) {
                        appointments[aptIndex].professionalId = replacement.replacement.professional.id;
                        
                        // If replacement professional had an appointment, remove it
                        if (replacement.replacement.currentAppointment) {
                            const currentIndex = appointments.findIndex(a => a.id === replacement.replacement.currentAppointment.id);
                            if (currentIndex !== -1) {
                                appointments.splice(currentIndex, 1);
                            }
                        }
                        
                        replacedCount++;
                    }
                });

                localStorage.setItem('appointments', JSON.stringify(appointments));
                loadScheduleGrid();
                loadWeeklyScheduleGrid();
                
                // Clear analysis
                currentAbsenceAnalysis = null;
                document.getElementById('absentProfessional').value = '';
                document.getElementById('absenceDay').value = '';
                document.getElementById('absenceAnalysis').classList.add('hidden');
                
                showSuccessMessage(`üö® Substitui√ß√£o de emerg√™ncia conclu√≠da! ${replacedCount} agendamentos foram transferidos.`);
            }
        }

        function showAbsenceOptions() {
            if (!currentAbsenceAnalysis) {
                alert('‚ö†Ô∏è Nenhuma an√°lise de falta dispon√≠vel!');
                return;
            }

            const { absentProf, absenceDate, replacementOptions } = currentAbsenceAnalysis;
            
            // Set header
            document.getElementById('absenceOptionsHeader').innerHTML = `
                üë®‚Äç‚öïÔ∏è Profissional Ausente: ${absentProf.name} | üìÖ Dia: ${currentAbsenceAnalysis.selectedDayName}
            `;
            
            // Generate options content
            let optionsHtml = '';
            selectedAbsenceReplacements = [];
            
            replacementOptions.forEach((item, itemIndex) => {
                const apt = item.appointment;
                const options = item.options;
                
                optionsHtml += `
                    <div class="bg-white border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4 pb-3 border-b">
                            <div>
                                <span class="font-bold text-lg">${apt.time} - ${apt.clientName}</span>
                                <span class="ml-3 px-3 py-1 rounded ${getAppointmentColor(apt.type)}">${getTypeLabel(apt.type)}</span>
                            </div>
                            <div class="text-sm text-gray-600">
                                ${options.length} op√ß√µes dispon√≠veis
                            </div>
                        </div>
                `;
                
                if (options.length > 0) {
                    optionsHtml += `<div class="space-y-2">`;
                    
                    options.forEach((option, optIndex) => {
                        const optionId = `absence_${itemIndex}_${optIndex}`;
                        const priorityIcon = getPriorityIcon(option.priority);
                        const priorityLabel = getPriorityLabel(option.priority);
                        const isRecommended = option.priority <= 3;
                        
                        optionsHtml += `
                            <label class="flex items-center justify-between p-3 border rounded cursor-pointer hover:bg-gray-50 ${isRecommended ? 'border-green-300 bg-green-50' : 'border-gray-200'}">
                                <div class="flex items-center space-x-3">
                                    <input type="radio" name="absence_${itemIndex}" value="${optionId}" 
                                           onchange="selectAbsenceReplacement('${optionId}', ${itemIndex}, ${optIndex})"
                                           ${isRecommended && optIndex === 0 ? 'checked' : ''}>
                                    <span class="text-xl">${priorityIcon}</span>
                                    <div>
                                        <div class="font-medium">${option.professional.name}</div>
                                        <div class="text-sm text-gray-600">${option.professional.specialty}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs px-2 py-1 rounded ${getPriorityColor(option.priority)}">${priorityLabel}</div>
                                    ${option.currentActivity ? `<div class="text-xs text-gray-500 mt-1">Atual: ${getTypeLabel(option.currentActivity)}</div>` : ''}
                                </div>
                            </label>
                        `;
                        
                        // Auto-select first recommended option
                        if (isRecommended && optIndex === 0) {
                            selectedAbsenceReplacements[itemIndex] = {
                                appointment: apt,
                                replacement: option
                            };
                        }
                    });
                    
                    // Option to not replace
                    optionsHtml += `
                        <label class="flex items-center justify-between p-3 border border-red-200 rounded cursor-pointer hover:bg-red-50">
                            <div class="flex items-center space-x-3">
                                <input type="radio" name="absence_${itemIndex}" value="no_replace_${itemIndex}" 
                                       onchange="selectAbsenceReplacement('no_replace_${itemIndex}', ${itemIndex}, -1)">
                                <span class="text-xl">üö´</span>
                                <div>
                                    <div class="font-medium text-red-600">N√£o substituir</div>
                                    <div class="text-sm text-red-500">Cancelar este agendamento</div>
                                </div>
                            </div>
                        </label>
                    `;
                    
                    optionsHtml += `</div>`;
                } else {
                    optionsHtml += `
                        <div class="text-center py-4 text-red-600">
                            <span class="text-2xl">‚ö†Ô∏è</span>
                            <div class="mt-2">Nenhuma op√ß√£o de substitui√ß√£o dispon√≠vel</div>
                            <div class="text-sm mt-1">Este agendamento precisar√° ser cancelado</div>
                        </div>
                    `;
                }
                
                optionsHtml += `</div>`;
            });
            
            document.getElementById('absenceOptionsContent').innerHTML = optionsHtml;
            document.getElementById('absenceOptionsModal').classList.add('active');
        }

        function selectAbsenceReplacement(optionId, itemIndex, optIndex) {
            if (optIndex === -1) {
                // No replacement selected
                selectedAbsenceReplacements[itemIndex] = null;
            } else {
                const item = currentAbsenceAnalysis.replacementOptions[itemIndex];
                selectedAbsenceReplacements[itemIndex] = {
                    appointment: item.appointment,
                    replacement: item.options[optIndex]
                };
            }
        }

        function selectAllAbsenceOptions() {
            if (!currentAbsenceAnalysis) return;
            
            currentAbsenceAnalysis.replacementOptions.forEach((item, index) => {
                if (item.options.length > 0) {
                    const bestOption = item.options[0]; // First option (highest priority)
                    selectedAbsenceReplacements[index] = {
                        appointment: item.appointment,
                        replacement: bestOption
                    };
                    
                    // Update radio button
                    const radio = document.querySelector(`input[name="absence_${index}"][value="absence_${index}_0"]`);
                    if (radio) radio.checked = true;
                }
            });
        }

        function deselectAllAbsenceOptions() {
            selectedAbsenceReplacements = [];
            
            // Clear all radio buttons
            const radios = document.querySelectorAll('#absenceOptionsContent input[type="radio"]');
            radios.forEach(radio => radio.checked = false);
        }

        function applySelectedAbsenceReplacements() {
            const validReplacements = selectedAbsenceReplacements.filter(r => r !== null && r !== undefined);
            
            if (validReplacements.length === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos uma substitui√ß√£o para aplicar!');
                return;
            }

            const confirmMessage = `üö® APLICAR SUBSTITUI√á√ïES SELECIONADAS\n\n` +
                `Ser√£o aplicadas ${validReplacements.length} substitui√ß√µes.\n\n` +
                `‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!\n\nDeseja continuar?`;

            if (confirm(confirmMessage)) {
                let replacedCount = 0;
                
                validReplacements.forEach(replacement => {
                    // Update the absent professional's appointment
                    const aptIndex = appointments.findIndex(a => a.id === replacement.appointment.id);
                    if (aptIndex !== -1) {
                        appointments[aptIndex].professionalId = replacement.replacement.professional.id;
                        
                        // If replacement professional had appointments, remove them all
                        if (replacement.replacement.affectedAppointments && replacement.replacement.affectedAppointments.length > 0) {
                            replacement.replacement.affectedAppointments.forEach(affectedApt => {
                                const currentIndex = appointments.findIndex(a => a.id === affectedApt.id);
                                if (currentIndex !== -1) {
                                    appointments.splice(currentIndex, 1);
                                }
                            });
                        }
                        
                        replacedCount++;
                    }
                });

                // Handle appointments that were not replaced (cancel them)
                const canceledAppointments = currentAbsenceAnalysis.appointments.filter(apt => 
                    !validReplacements.some(r => r.appointment.id === apt.id)
                );
                
                canceledAppointments.forEach(apt => {
                    const index = appointments.findIndex(a => a.id === apt.id);
                    if (index !== -1) {
                        appointments.splice(index, 1);
                    }
                });

                localStorage.setItem('appointments', JSON.stringify(appointments));
                loadScheduleGrid();
                loadWeeklyScheduleGrid();
                
                closeModal('absenceOptionsModal');
                
                // Clear analysis
                currentAbsenceAnalysis = null;
                selectedAbsenceReplacements = [];
                document.getElementById('absentProfessional').value = '';
                document.getElementById('absenceDay').value = '';
                document.getElementById('absenceAnalysis').classList.add('hidden');
                
                const canceledCount = canceledAppointments.length;
                let message = `‚úÖ ${replacedCount} substitui√ß√µes aplicadas com sucesso!`;
                if (canceledCount > 0) {
                    message += `\nüóëÔ∏è ${canceledCount} agendamentos foram cancelados.`;
                }
                
                showSuccessMessage(message);
            }
        }

        // Time Slot Options Functions
        function showTimeSlotOptions(itemIndex) {
            if (!currentAbsenceAnalysis || !currentAbsenceAnalysis.replacementOptions[itemIndex]) {
                alert('‚ö†Ô∏è Dados de an√°lise n√£o encontrados!');
                return;
            }

            const item = currentAbsenceAnalysis.replacementOptions[itemIndex];
            const apt = item.appointment;
            const options = item.options;
            const absentProf = currentAbsenceAnalysis.absentProf;
            const selectedDayName = currentAbsenceAnalysis.selectedDayName;

            // Set header
            document.getElementById('timeSlotHeader').innerHTML = `
                üïê <strong>${apt.time}</strong> - ${apt.clientName} (${getTypeLabel(apt.type)})<br>
                üë®‚Äç‚öïÔ∏è Profissional Ausente: ${absentProf.name} | üìÖ Dia: ${selectedDayName}
            `;

            // Generate options content
            let optionsHtml = '';

            if (options.length === 0) {
                optionsHtml = `
                    <div class="text-center py-8 text-red-600">
                        <span class="text-4xl">‚ö†Ô∏è</span>
                        <div class="mt-3 text-lg font-medium">Nenhuma op√ß√£o de substitui√ß√£o dispon√≠vel</div>
                        <div class="text-sm mt-2">Este agendamento precisar√° ser cancelado ou reagendado manualmente</div>
                    </div>
                `;
            } else {
                optionsHtml = options.map((option, optIndex) => {
                    const priorityIcon = getPriorityIcon(option.priority);
                    const priorityLabel = getPriorityLabel(option.priority);
                    const isRecommended = option.priority <= 3;
                    
                    return `
                        <div class="border rounded-lg p-4 hover:shadow-md transition-shadow ${isRecommended ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-white'}">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">${priorityIcon}</span>
                                    <div>
                                        <div class="font-bold text-lg">${option.professional.name}</div>
                                        <div class="text-sm text-gray-600">${option.professional.specialty}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="px-3 py-1 rounded text-sm font-medium ${getPriorityColor(option.priority)}">${priorityLabel}</div>
                                    ${isRecommended ? '<div class="text-xs text-green-600 mt-1">‚úÖ Recomendado</div>' : ''}
                                </div>
                            </div>
                            
                            ${option.currentActivity ? `
                                <div class="mb-3 bg-yellow-50 p-3 rounded border border-yellow-200">
                                    <div class="font-medium text-yellow-800 mb-1">üìã Agendamento Atual do Substituto:</div>
                                    <div class="text-sm text-yellow-700">
                                        ${option.currentAppointment ? option.currentAppointment.clientName : 'Cliente n√£o identificado'} - ${getTypeLabel(option.currentActivity)}
                                    </div>
                                    <div class="text-xs text-yellow-600 mt-1">
                                        ‚ö†Ô∏è Este agendamento ser√° ${option.currentActivity === 'cls' || option.currentActivity === 'analise' || option.currentActivity === 'supervisao' || option.currentActivity === 'discussao' ? 'cancelado' : 'transferido'}
                                    </div>
                                </div>
                            ` : `
                                <div class="mb-3 bg-green-50 p-3 rounded border border-green-200">
                                    <div class="text-sm text-green-700">
                                        ‚úÖ <strong>Hor√°rio completamente livre</strong> - Nenhum conflito
                                    </div>
                                </div>
                            `}
                            
                            <div class="flex gap-2">
                                <button onclick="executeTimeSlotReplacement(${itemIndex}, ${optIndex})" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium transition-colors">
                                    üîÑ Executar Substitui√ß√£o
                                </button>
                                ${option.currentActivity ? `
                                    <button onclick="showReplacementDetails(${itemIndex}, ${optIndex})" 
                                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded text-sm transition-colors">
                                        üëÅÔ∏è Detalhes
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('timeSlotOptionsContent').innerHTML = optionsHtml;
            document.getElementById('timeSlotOptionsModal').classList.add('active');
        }

        function executeTimeSlotReplacement(itemIndex, optionIndex) {
            if (!currentAbsenceAnalysis || !currentAbsenceAnalysis.replacementOptions[itemIndex]) {
                alert('‚ö†Ô∏è Dados de an√°lise n√£o encontrados!');
                return;
            }

            const item = currentAbsenceAnalysis.replacementOptions[itemIndex];
            const apt = item.appointment;
            const option = item.options[optionIndex];
            const absentProf = currentAbsenceAnalysis.absentProf;

            // Prepare confirmation message
            let confirmMessage = `üîÑ CONFIRMAR SUBSTITUI√á√ÉO\n\n`;
            confirmMessage += `üìÖ Hor√°rio: ${apt.time}\n`;
            confirmMessage += `üë®‚Äç‚öïÔ∏è Saindo: ${absentProf.name}\n`;
            confirmMessage += `üë®‚Äç‚öïÔ∏è Entrando: ${option.professional.name}\n\n`;
            confirmMessage += `üìã Agendamento: ${apt.clientName} (${getTypeLabel(apt.type)})\n\n`;

            if (option.currentActivity) {
                confirmMessage += `‚ö†Ô∏è ATEN√á√ÉO: ${option.professional.name} possui agendamento neste hor√°rio:\n`;
                confirmMessage += `‚Ä¢ ${option.currentAppointment ? option.currentAppointment.clientName : 'Cliente'} (${getTypeLabel(option.currentActivity)})\n`;
                confirmMessage += `‚Ä¢ Este agendamento ser√° CANCELADO\n\n`;
            } else {
                confirmMessage += `‚úÖ ${option.professional.name} est√° livre neste hor√°rio\n\n`;
            }

            confirmMessage += `‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!\n\nDeseja continuar?`;

            if (confirm(confirmMessage)) {
                // Execute the replacement
                const aptIndex = appointments.findIndex(a => a.id === apt.id);
                if (aptIndex !== -1) {
                    // Update the absent professional's appointment to the new professional
                    appointments[aptIndex].professionalId = option.professional.id;
                    
                    // Remove conflicting appointments from the replacement professional
                    if (option.affectedAppointments && option.affectedAppointments.length > 0) {
                        option.affectedAppointments.forEach(affectedApt => {
                            const currentIndex = appointments.findIndex(a => a.id === affectedApt.id);
                            if (currentIndex !== -1) {
                                appointments.splice(currentIndex, 1);
                            }
                        });
                    }

                    // Save changes
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    loadScheduleGrid();
                    loadWeeklyScheduleGrid();
                    
                    // Close modal and show success
                    closeModal('timeSlotOptionsModal');
                    
                    let successMessage = `‚úÖ Substitui√ß√£o executada com sucesso!\n\n`;
                    successMessage += `${apt.clientName} agora ser√° atendido por ${option.professional.name}`;
                    
                    if (option.currentActivity) {
                        successMessage += `\n\nüóëÔ∏è O agendamento conflitante foi cancelado`;
                    }
                    
                    showSuccessMessage(successMessage);
                    
                    // Refresh the absence analysis
                    analyzeAbsenceReplacement();
                } else {
                    alert('‚ùå Erro: Agendamento n√£o encontrado!');
                }
            }
        }

        function showReplacementDetails(itemIndex, optionIndex) {
            if (!currentAbsenceAnalysis || !currentAbsenceAnalysis.replacementOptions[itemIndex]) {
                return;
            }

            const item = currentAbsenceAnalysis.replacementOptions[itemIndex];
            const option = item.options[optionIndex];
            
            let details = `üìã DETALHES DA SUBSTITUI√á√ÉO\n\n`;
            details += `üë®‚Äç‚öïÔ∏è Profissional: ${option.professional.name}\n`;
            details += `üè• Especialidade: ${option.professional.specialty}\n`;
            details += `üèÜ Prioridade: ${getPriorityLabel(option.priority)}\n\n`;
            
            if (option.currentActivity) {
                details += `üìÖ Agendamento Atual:\n`;
                details += `‚Ä¢ Cliente: ${option.currentAppointment ? option.currentAppointment.clientName : 'N/A'}\n`;
                details += `‚Ä¢ Tipo: ${getTypeLabel(option.currentActivity)}\n`;
                details += `‚Ä¢ A√ß√£o: Este agendamento ser√° cancelado\n\n`;
                
                if (option.affectedAppointments && option.affectedAppointments.length > 1) {
                    details += `‚ö†Ô∏è Outros agendamentos afetados: ${option.affectedAppointments.length - 1}\n`;
                }
            } else {
                details += `‚úÖ Profissional est√° completamente livre neste hor√°rio\n`;
            }
            
            details += `\nüí° Esta substitui√ß√£o √© ${option.priority <= 3 ? 'RECOMENDADA' : 'poss√≠vel, mas n√£o priorit√°ria'}`;
            
            alert(details);
        }

        // Hidden System Reset Functions
        function trackResetSequence(buttonType) {
            // Only allow admins to activate reset sequence
            if (!currentUser || currentUser.level !== 'admin') {
                return;
            }
            
            // Clear any existing timeout
            if (resetSequenceTimeout) {
                clearTimeout(resetSequenceTimeout);
            }
            
            // Add button to sequence
            resetSequence.push(buttonType);
            
            // Keep only the last 5 clicks
            if (resetSequence.length > 5) {
                resetSequence.shift();
            }
            
            // Check if sequence matches target
            if (resetSequence.length === 5 && 
                JSON.stringify(resetSequence) === JSON.stringify(resetSequenceTarget)) {
                
                // Show hidden reset button
                const resetButton = document.getElementById('hiddenResetButton');
                resetButton.style.display = 'inline-block';
                resetButton.classList.add('animate-pulse');
                
                // Add visual feedback
                resetButton.style.animation = 'pulse 1s infinite';
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    resetButton.style.display = 'none';
                    resetButton.classList.remove('animate-pulse');
                    resetSequence = [];
                }, 10000);
                
                // Show subtle notification
                showResetActivatedMessage();
            }
            
            // Reset sequence after 5 seconds of inactivity
            resetSequenceTimeout = setTimeout(() => {
                resetSequence = [];
            }, 5000);
        }

        function showResetActivatedMessage() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 left-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm';
            notification.innerHTML = 'üî• MODO ADMINISTRADOR: Bot√£o de Reset Total ativado por 10 segundos';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function executeSystemReset() {
            if (!checkPermission('systemReset')) {
                showPermissionDenied('systemReset');
                return;
            }
            
            const confirmMessage = `üî• ATEN√á√ÉO: FORMATA√á√ÉO COMPLETA DO SISTEMA\n\n` +
                `Esta a√ß√£o ir√° FORMATAR COMPLETAMENTE o programa:\n\n` +
                `üí• EXCLUS√ÉO TOTAL E PERMANENTE:\n` +
                `‚Ä¢ TODOS os profissionais (${professionals.length} cadastrados)\n` +
                `‚Ä¢ TODOS os agendamentos (${appointments.length} registros)\n` +
                `‚Ä¢ TODAS as planilhas importadas\n` +
                `‚Ä¢ TODOS os dados salvos no navegador\n` +
                `‚Ä¢ TODAS as configura√ß√µes e filtros\n` +
                `‚Ä¢ TODO o hist√≥rico de a√ß√µes\n` +
                `‚Ä¢ TODOS os dados de login salvos\n\n` +
                `üîÑ RESTAURA√á√ÉO:\n` +
                `‚Ä¢ Sistema volta ao estado inicial (zero dados)\n` +
                `‚Ä¢ Como se fosse a primeira vez usando\n` +
                `‚Ä¢ Nenhum dado ser√° recuper√°vel\n` +
                `‚Ä¢ Todas as importa√ß√µes ser√£o perdidas\n\n` +
                `‚ö†Ô∏è ESTA A√á√ÉO √â IRREVERS√çVEL E PERMANENTE!\n` +
                `‚ö†Ô∏è N√ÉO H√Å COMO DESFAZER ESTA OPERA√á√ÉO!\n` +
                `‚ö†Ô∏è APENAS ADMINISTRADORES PODEM EXECUTAR!\n\n` +
                `Digite exatamente "CONFIRMAR RESET" para continuar:`;

            const userInput = prompt(confirmMessage);
            
            if (userInput === "CONFIRMAR RESET") {
                const finalConfirm = confirm(`üö® √öLTIMA CONFIRMA√á√ÉO - FORMATA√á√ÉO TOTAL\n\n` +
                    `Voc√™ est√° prestes a FORMATAR COMPLETAMENTE o sistema!\n\n` +
                    `üìä Dados que ser√£o PERDIDOS PARA SEMPRE:\n` +
                    `‚Ä¢ ${professionals.length} profissionais cadastrados\n` +
                    `‚Ä¢ ${appointments.length} agendamentos salvos\n` +
                    `‚Ä¢ Todas as importa√ß√µes realizadas\n` +
                    `‚Ä¢ Todo o hist√≥rico de trabalho\n\n` +
                    `üíÄ ESTA √â SUA √öLTIMA CHANCE DE CANCELAR!\n\n` +
                    `Tem ABSOLUTA CERTEZA que deseja FORMATAR TUDO?`);
                
                if (finalConfirm) {
                    // Show formatting progress
                    const formatNotification = document.createElement('div');
                    formatNotification.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-800 text-white px-8 py-6 rounded-lg shadow-2xl z-50 text-center';
                    formatNotification.innerHTML = `
                        <div class="text-4xl mb-3">üî•</div>
                        <div class="text-xl font-bold mb-2">FORMATANDO SISTEMA...</div>
                        <div class="text-sm">Apagando todos os dados...</div>
                        <div class="animate-pulse text-xs mt-2">Por favor aguarde...</div>
                    `;
                    document.body.appendChild(formatNotification);
                    
                    // Simulate formatting delay for dramatic effect
                    setTimeout(() => {
                        // COMPLETE SYSTEM WIPE - Clear ALL possible data
                        
                        // 1. Clear localStorage completely
                        localStorage.clear();
                        
                        // 2. Clear sessionStorage as well
                        sessionStorage.clear();
                        
                        // 3. Reset ALL global variables to initial state
                        professionals = [];
                        appointments = [];
                        selectedProfessional = '';
                        currentWeek = new Date();
                        currentView = 'schedule';
                        
                        // 4. Clear all analysis data and imported data
                        currentAbsenceAnalysis = null;
                        currentReplacementAnalysis = null;
                        selectedAbsenceReplacements = [];
                        selectedBulkAppointments = [];
                        filteredBulkAppointments = [];
                        conflictResolutions = [];
                        selectedResolutions = {};
                        importPreviewData = null;
                        selectedFile = null;
                        
                        // 4.1. Clear any cached or temporary data
                        if (window.importedData) delete window.importedData;
                        if (window.exportedData) delete window.exportedData;
                        
                        // 5. Reset sequence tracking
                        resetSequence = [];
                        if (resetSequenceTimeout) {
                            clearTimeout(resetSequenceTimeout);
                            resetSequenceTimeout = null;
                        }
                        
                        // 6. Clear all form inputs
                        const allInputs = document.querySelectorAll('input, select, textarea');
                        allInputs.forEach(input => {
                            if (input.type === 'checkbox' || input.type === 'radio') {
                                input.checked = false;
                            } else {
                                input.value = '';
                            }
                        });
                        
                        // 7. Close all modals
                        const allModals = document.querySelectorAll('.modal');
                        allModals.forEach(modal => {
                            modal.classList.remove('active');
                        });
                        
                        // 8. Hide reset button
                        document.getElementById('hiddenResetButton').style.display = 'none';
                        
                        // 9. Clear all dynamic content
                        document.getElementById('scheduleGrid').innerHTML = '';
                        document.getElementById('weeklyScheduleGrid').innerHTML = '';
                        document.getElementById('professionalsList').innerHTML = '';
                        document.getElementById('reportsContent').innerHTML = '';
                        document.getElementById('bulkAppointmentsList').innerHTML = '';
                        
                        // 10. Reset all filters and searches
                        document.getElementById('professionalFilter').innerHTML = '<option value="">Todos os Profissionais</option>';
                        document.getElementById('weeklyProfessionalFilter').innerHTML = '<option value="">Todos os Profissionais</option>';
                        document.getElementById('appointmentProfessional').innerHTML = '<option value="">Selecione o profissional...</option>';
                        document.getElementById('mainProfessionalSearch').value = '';
                        document.getElementById('professionalSearch').value = '';
                        
                        // 11. Hide selected professional info
                        document.getElementById('selectedProfessionalInfo').classList.add('hidden');
                        document.getElementById('weeklyEmptyState').classList.remove('hidden');
                        
                        // 12. Reset bulk edit filters
                        clearBulkFilters();
                        
                        // 13. Force reload all UI components
                        updateProfessionalFilter();
                        updateWeeklyProfessionalFilter();
                        loadScheduleGrid();
                        loadWeeklyScheduleGrid();
                        
                        // Remove formatting notification
                        if (formatNotification.parentNode) {
                            formatNotification.parentNode.removeChild(formatNotification);
                        }
                        
                        // Show dramatic success message
                        const successNotification = document.createElement('div');
                        successNotification.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-600 text-white px-10 py-8 rounded-lg shadow-2xl z-50 text-center max-w-md';
                        successNotification.innerHTML = `
                            <div class="text-6xl mb-4">‚úÖ</div>
                            <div class="text-2xl font-bold mb-3">SISTEMA FORMATADO!</div>
                            <div class="text-sm mb-2">üî• Formata√ß√£o completa realizada com sucesso</div>
                            <div class="text-sm mb-2">üíæ Todos os dados foram permanentemente removidos</div>
                            <div class="text-sm mb-4">üÜï Sistema restaurado ao estado inicial</div>
                            <div class="text-xs bg-green-700 px-3 py-2 rounded">
                                O programa est√° agora como se fosse a primeira vez sendo usado
                            </div>
                        `;
                        
                        document.body.appendChild(successNotification);
                        
                        // Auto-remove success notification after 8 seconds
                        setTimeout(() => {
                            if (successNotification.parentNode) {
                                successNotification.parentNode.removeChild(successNotification);
                            }
                        }, 8000);
                        
                        // Force return to main schedule view (clean state)
                        showScheduleView();
                        
                        // Optional: Force page reload for complete reset (uncomment if needed)
                        // setTimeout(() => {
                        //     window.location.reload();
                        // }, 3000);
                        
                    }, 2000); // 2 second delay for dramatic effect
                    
                } else {
                    alert('‚ùå Formata√ß√£o cancelada pelo usu√°rio');
                }
            } else {
                alert('‚ùå Texto de confirma√ß√£o incorreto. Formata√ß√£o cancelada por seguran√ßa.\n\nVoc√™ deve digitar exatamente: CONFIRMAR RESET');
            }
            
            // Hide reset button after use (regardless of outcome)
            document.getElementById('hiddenResetButton').style.display = 'none';
            resetSequence = [];
        }

        // Clear All Data Function
        function clearAllData() {
            const confirmMessage = `üóëÔ∏è LIMPAR TODOS OS DADOS\n\nDeseja apagar tudo?\n\n‚ö†Ô∏è Esta a√ß√£o ir√° remover:\n‚Ä¢ Todos os profissionais cadastrados (${professionals.length})\n‚Ä¢ Todos os agendamentos (${appointments.length})\n‚Ä¢ Todas as configura√ß√µes\n‚Ä¢ Todos os dados importados\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!\n\nTem certeza?`;
            
            if (confirm(confirmMessage)) {
                // Clear all data
                professionals = [];
                appointments = [];
                selectedProfessional = '';
                currentWeek = new Date();
                currentView = 'schedule';
                
                // Clear localStorage
                localStorage.removeItem('professionals');
                localStorage.removeItem('appointments');
                
                // Clear all analysis data
                currentAbsenceAnalysis = null;
                currentReplacementAnalysis = null;
                selectedAbsenceReplacements = [];
                selectedBulkAppointments = [];
                filteredBulkAppointments = [];
                conflictResolutions = [];
                selectedResolutions = {};
                importPreviewData = null;
                selectedFile = null;
                
                // Clear all form inputs
                const allInputs = document.querySelectorAll('input, select, textarea');
                allInputs.forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                
                // Close all modals
                const allModals = document.querySelectorAll('.modal');
                allModals.forEach(modal => {
                    modal.classList.remove('active');
                });
                
                // Clear all dynamic content
                document.getElementById('scheduleGrid').innerHTML = '';
                document.getElementById('weeklyScheduleGrid').innerHTML = '';
                document.getElementById('professionalsList').innerHTML = '';
                document.getElementById('reportsContent').innerHTML = '';
                document.getElementById('bulkAppointmentsList').innerHTML = '';
                
                // Reset all filters
                document.getElementById('professionalFilter').innerHTML = '<option value="">Todos os Profissionais</option>';
                document.getElementById('weeklyProfessionalFilter').innerHTML = '<option value="">Todos os Profissionais</option>';
                document.getElementById('appointmentProfessional').innerHTML = '<option value="">Selecione o profissional...</option>';
                document.getElementById('mainProfessionalSearch').value = '';
                document.getElementById('professionalSearch').value = '';
                
                // Hide selected professional info
                document.getElementById('selectedProfessionalInfo').classList.add('hidden');
                document.getElementById('weeklyEmptyState').classList.remove('hidden');
                
                // Reset bulk edit filters
                clearBulkFilters();
                
                // Update UI
                updateProfessionalFilter();
                updateWeeklyProfessionalFilter();
                loadScheduleGrid();
                loadWeeklyScheduleGrid();
                
                // Show success message
                showSuccessMessage('üóëÔ∏è Todos os dados foram apagados com sucesso! Sistema limpo.');
                
                // Return to main schedule view
                showScheduleView();
            }
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9779022160c7f1f6',t:'MTc1NjYwNjQwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
